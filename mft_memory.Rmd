---
title: "A Functional Neuroimaging Investigation of Moral Foundations Theory"
output: 
editor_options: 
  chunk_output_type: console
---

```{r load packages}
library(tidyverse)
library(lme4)
library(lmerTest)
library(emmeans)
library(performance)
library(devtools)
library(ggpubr)
library(ggeffects)
library(sjPlot)
library(RColorBrewer)
library(paletti)
library(patchwork)
library(ggcorrplot)
library(extrafont)
```

# Global variables, helper functions, etc
```{r custom global things}
se <- function(x) sqrt(var(x)/length(x))
`%notin%` <- Negate(`%in%`)
emm_options(lmerTest.limit = 5000)

# getting var names straightened out 
assignCategory <- function(c) {
  return(ifelse(substr(c, 1,4) == 'auth', 'Authority', 
         ifelse(substr(c, 1,7) == 'careemo', 'Harm-Emo', 
         ifelse(substr(c, 1,5) == 'carem', 'Harm-Emo',
         ifelse(substr(c, 1,8) == 'carephys', 'Harm-Phys', 
         ifelse(substr(c, 1,5) == 'carep', 'Harm-Phys',
         ifelse(substr(c, 1,4) == 'fair', 'Fairness', 
         ifelse(substr(c, 1,3) == 'lib', 'Liberty', 
         ifelse(substr(c, 1,3) == 'loy', 'Loyalty',
         ifelse(substr(c, 1,3) == 'pur' , 'Purity', 
         ifelse(substr(c, 1,4) == 'socn', 'Social Norms',
         ifelse(substr(c, 1,7) == 'socnorm', 'Social Norms', NA))))))))))))
}
plotting_categories <- c('Social Norms', 
                         'Authority', 'Loyalty', 'Purity', 
                         'Harm-Emo', 'Harm-Phys', 'Fairness', 
                         'Liberty')

matlab_categories <- c('Authority', 'Harm-Emo', 'Harm-Phys', 'Fairness', 'Liberty', 
                       'Loyalty', 'Purity', 'Social Norms')

# assign superordinate category
superordinateCategory <- function(c) {
  return(ifelse(c == 'Harm-Emo', 'Individualizing',
         ifelse(c == 'Harm-Phys', 'Individualizing',
         ifelse(c == 'Fairness', 'Individualizing',
         ifelse(c == 'Loyalty', 'Binding',
         ifelse(c == 'Authority', 'Binding',
         ifelse(c == 'Purity', 'Binding', as.character(c))))))))
}

# contrasts 
SuperordinateContrasts <- list(LibertyVsSocial=c(-1, 0, 0, 0, 0, 0, 0, 1),
                BindingVsSocial=c(-1, 1/3, 1/3, 1/3, 0, 0, 0,0),
                IndividualizingVsSocial=c(-1, 0, 0, 0, 1/3, 1/3, 1/3, 0),
                LibertyVsBinding=c(0, -1/3, -1/3, -1/3, 0, 0, 0, 1),
                LibertyVsIndividualizing=c(0, 0, 0, 0, -1/3, -1/3, -1/3, 1),
                IndividualizingVsBinding=c(0, 0, -1/3, -1/3, -1/3, 1/3, 1/3, 1/3))

superordinate <- function(levels) {
  if (length(levels) == 8) {
    return(as.data.frame(SuperordinateContrasts))
  }
  return(NULL)
}

# custom color palette
## shoutout https://edwinth.github.io/blog/paletti/ for the elegant paletti method of doing this
## https://learnui.design/tools/data-color-picker.html used for generating the gradients, but I heavily tweaked the default output
colors <- c('#c179f7', '#c40233', '#E60026','#ea3c53', '#2b8cd6', '#86b1e4','#bfd2f2','#7CAE00')
#viz_palette(colors) - uncomment to visualize palette
mem_colors <- c('#c179f7', '#c40233', '#E60026','#ea3c53', '#2b8cd6', '#86b1e4','#bfd2f2','#7CAE00',
                '#c179f7', '#c40233', '#E60026','#ea3c53', '#2b8cd6', '#86b1e4','#bfd2f2','#7CAE00')
#viz_palette(mem_colors)
MFT_fill  <- get_scale_fill(get_pal(colors))
MFT_color <- get_scale_color(get_pal(colors))
MFT_memfill <- get_scale_fill(get_pal(mem_colors))
MFT_memcol <- get_scale_color(get_pal(mem_colors))

# PLS plotting functions 
# plotting functions
brain_scores <- function(df, LV, title) {
  ggplot(df, aes_(x=~category, y=LV, fill=~category, color=~category)) +
    geom_hline(aes(yintercept = 0), size = 0.5) +
    labs(y = 'Brain scores', x = 'Foundation', title = title) +
    geom_col(color='black') + 
    geom_point(color='black', size=1) +
    geom_errorbar(aes(ymax = upper, ymin = lower), color='black', size=0.5, width=0.25) +
    scale_x_discrete(labels = c('S.N.', 'Auth.', 'Loy.', 'Pur.', 'Harm-E.', 'Harm-P.', 'Fair.', 'Lib.')) +
    theme_pubr(legend = 'none') +
    theme(axis.title.x = element_blank(),
          axis.title.y = element_text(size=14),
          axis.text = element_text(size = 14),
          plot.title = element_text(hjust = 0.5, size = 16))
}

temporal_brain_scores <- function(df) {
    lmer(score ~ lag * category + (1 | subID), data = df) %>%
    emmeans(~ lag * category) %>% as.data.frame() %>%
    mutate(superordinate = superordinateCategory(category),
           category = factor(category, levels = plotting_categories)) %>%
    ggplot(aes(x=lag, y=emmean, group=category, color=category, fill=category))  + 
    scale_x_discrete(expand = c(0, 0, 0, 0.1), labels = c('TR1', 'TR2', 'TR3', 'TR4', 'TR5', 'TR6', 'TR7')) +
    geom_hline(aes(yintercept = 0), size=1) +
    geom_line(size=1) + 
    geom_point(aes(fill=category, color=category, shape = category), size=3) +
    scale_shape_manual(values = c(4,15,16,17,0,1,2, 3)) +
    theme_pubr(legend = 'right') +
    theme(axis.title.x = element_blank(),
          axis.title.y = element_text(size=14), 
          axis.text = element_text(size = 14)) +
    labs(y = 'Temporal brain scores', color='Foundation', fill='Foundation', shape='Foundation')
}
```

# Load in data
```{r Load in data}
# load encoding data
encodingfiles = list.files('data/behavior/encoding', full.names = TRUE, pattern = '.csv', recursive = FALSE)
encodingFull = do.call(rbind, lapply(encodingfiles, function(x){read.csv(x, header = TRUE, stringsAsFactors = FALSE)}))

# load retrieval data
retfiles = list.files('data/behavior/retrieval', full.names = TRUE, pattern = '.csv', recursive = FALSE)
retFull = do.call(rbind, lapply(retfiles, function(x){read.csv(x, header = TRUE, stringsAsFactors = FALSE)}))

# load vignette key
key <- read.csv('data/key.csv', stringsAsFactors = FALSE)

# load qualtrics
foundation_matching <- read.csv('data/behavior/qualtrics/foundation_matching.csv', stringsAsFactors = FALSE)
all_other_surveys <- read.csv('data/behavior/qualtrics/all_other_surveys.csv', stringsAsFactors = FALSE)
```


# Tidy behavioral data
```{r Tidy data & analysis prep}
# tidy encoding
envars <- names(encodingFull) %in% c('run','pres_order','vignum','trialstart_raw','trialstart_zeroed','trialstart_TR','trialdur','intended_jitter','ITI_start_raw','ITI_start_zeroed','ITI_start_TR','ITI_duration','ITI_accuracy', 'foundation', 'vigtext') 
encoding_behav <- encodingFull[!envars]
encoding_behav <- filter(encoding_behav, vigfile != 99999)
#get rid of '.jpg' suffix
encoding_behav <- as.data.frame(sapply(encoding_behav, function(x) gsub(".jpg", "", x)), stringsAsFactors = FALSE) 
names(encoding_behav)[4]<-"encoding_RT"
#get rid of symbols, quotation marks, & any white space
encoding_behav$moral_decision <- as.numeric(encoding_behav$moral_decision)
encoding_behav <- as.data.frame(sapply(encoding_behav, function(x) gsub("^\t* *\"* *| *\"* *\t*$", "", x)), stringsAsFactors = FALSE) 

# tidy key
key <- as.data.frame(sapply(key, function(x) gsub("^\t* *\"* *| *\"* *\t*$", "", x)), stringsAsFactors = FALSE)
key <- subset(key, select = -c(correct_answer, choice1, choice2, choice3)) #delete extra columns

# tidy retrieval
ret_all <- retFull
ret_all$resp <- sapply(ret_all$resp, function(s) as.numeric(substr(s, 1, 2))) #get rid of symbols
ret_all$confresp <- sapply(ret_all$confresp, function(s) as.numeric(substr(s, 1, 2))) #get rid of symbols
ret_all <- as.data.frame(sapply(ret_all, function(x) gsub("^\t* *\"* *| *\"* *\t*$", "", x)), stringsAsFactors = FALSE) #get rid of quotation marks & any white space
ret_all <- left_join(ret_all, key) #make column with category for each cue
ret_all$old <- as.numeric(substr(ret_all$category, 1,4) != 'Lure') #add old/new status of each item
ret_all$category <- sapply(ret_all$category, function(x) gsub("Lure-", "", x)) #get rid of 'Lure-' prefix
ret_all$vigfile[ret_all$vigfile == ''] = NA
names(ret_all)[8]<-"retrieval_RT"

# determine which subjects I have all data for
sort(as.numeric(levels(as.factor(encoding_behav$subID))))
sort(as.numeric(levels(as.factor(ret_all$subID)))) 
## missing encoding data for sub 35
## missing retrieval data for sub 36

# one big happy dataframe
encoding <- subset(encoding_behav, encoding_behav$subID %in% ret_all$subID) # subset of encoding files that have corresponding retrieval files
retrieval <- subset(ret_all, ret_all$subID %in% encoding_behav$subID) # subset of retrieval files that have corresponding encoding files
data <- merge(retrieval, encoding, by=c('subID', 'vigfile'), all.x = TRUE) # congolomerate of these 
#sort(as.numeric(levels(as.factor(encoding_behav$subID))))
#sort(as.numeric(levels(as.factor(data$subID))))
#sort(as.numeric(levels(as.factor(all_other_surveys$subID))))
dataN = length(levels(as.factor(data$subID)))
dataSubs = sort(as.numeric(levels(as.factor(data$subID))))
#qualtricsSubs = sort(as.numeric(levels(as.factor(all_other_surveys$subID)))) 
## missing qualtrics data for sub 20

# homogenize variable names
data$category[data$category == "SN"] <- "Social-Norms"
data$category[data$category == "Lib"] <- "Liberty"
data$category[data$category == "Loy"] <- "Loyalty"
data$category[data$category == "Pure"] <- "Purity"
data$category[data$category == "Auth"] <- "Authority"
data$category[data$category == "Fair"] <- "Fairness"
data$category[data$category == "Social-Norms"] <- "Social Norms"
data$category[data$category == "Care-Phys"] <- "Harm-Phys"
data$category[data$category == "Care-Emo"] <- "Harm-Emo"

# make text-based response column; new responses = NA
data$text_response = ''
i = 0
for (n in data$resp) {
  i = i + 1
  if (is.na(n) == TRUE) {                       
    data$text_response[i] = NA
  } else if (n == 1) {
    data$text_response[i] = data$choice1[i]
  } else if (n == 2) {
    data$text_response[i] = data$choice2[i]
  } else if (n == 3) {
    data$text_response[i] = data$choice3[i]
  } else {
    data$text_response[i] = NA
  }
} 

# make column for modeling proportion correct
data$correct <- as.numeric((!is.na(data$text_response) & data$text_response == data$correct_answer) |
  (is.na(data$text_response) & data$old == 0))

# make columns with superordinate categories
data$superordinate = (superordinateCategory(data$category))
data$superordinate <- factor(data$superordinate, levels = c('Social Norms', 'Liberty', "Individualizing", "Binding"))

# convert RTs & moral judgment to numeric
RT_cols <- c(9,11,15)
data[, RT_cols] <- data %>% select(ends_with('RT')) %>% sapply(as.numeric)
data <- data %>% filter(retrieval_RT > 0.25) %>%
  filter(confRT > 0.25) %>%
  mutate(moral_decision=as.numeric(moral_decision),
         confresp=as.numeric(confresp),
         category=factor(category, levels=plotting_categories),
         old=factor(old, levels = c('1', '0')))

# add normed arousal data
mfv <- read.csv('data/mfv_norms.csv') 
mfv <- mfv %>% filter(vigfile %in% data$vigfile) %>% 
  select(category, vigfile, moral_decision, arousal) %>% 
  mutate(category = factor(category, levels = plotting_categories))
mfv_arousal <- mfv %>% select(vigfile, arousal)
data <- left_join(data, mfv_arousal, by='vigfile')

# for behavioral analyses and plotting
data <- data %>% group_by(subID, category, old) %>% mutate(propCorrect = mean(correct)) %>% ungroup() # so that violin plots can reflect participant response densities
confLabels <- c('1' = 'Correct', '0' = 'Incorrect')
memLabels <- c('1' = 'Old', '0' = 'New')

# make data_old
data_old <- subset(data, old == '1' & encoding_RT > 0.25)

# make data_sup
# score secs - conservatism increases with score
secs <- select(all_other_surveys, starts_with('sub'), starts_with('secs'))
colnames(secs) <- substr(colnames(secs), 6, 8)
colnames(secs) <- paste0('var', colnames(secs))
names(secs)[1] <- 'subID'
secs <- secs[-1,]
secs[,2:13] <- as.numeric(unlist(secs[,2:13]))
social <- c('var1','var3','var4','var7','var8','var11','var12')
economic <- c('var2', 'var5', 'var6', 'var9', 'var10')
reverse100 <- function(x) 100 - x
reverseScoredSECS <- c('var1', 'var5')
secs[,reverseScoredSECS] <- reverse100(secs[,reverseScoredSECS])
secs <- secs %>% 
  mutate(SocialConservatism = rowMeans(select(., social), na.rm = TRUE),
         EconomicConservatism = rowMeans(select(., economic), na.rm = TRUE),
         MeanConservatism = rowMeans(select(., var1:var12), na.rm = TRUE),
         subID = as.numeric(subID)) %>%
  filter(subID != 20, subID %in% dataSubs)

secs_means <- secs %>%
  summarise(socialConservatismMean = mean(SocialConservatism),
            socialConservatismSD = sd(SocialConservatism),
            economicConservatismMean = mean(EconomicConservatism),
            economicConservatismSD = sd(EconomicConservatism))

data_sup <- secs %>% select(subID, MeanConservatism) %>%
  merge(data, .)
```


# mean-centered PLS plots
```{r make PLS plots}
#### all conditions ####
# prep main df
all_mean <- read.csv('data/PLS/mean-centered/all_conditions/means.csv')
all_mean$category <- matlab_categories
all_mean$superordinate <- superordinateCategory(all_mean$category)
all_upper_CIs <- read.csv('data/PLS/mean-centered/all_conditions/upper_adj.csv')
all_lower_CIs <- read.csv('data/PLS/mean-centered/all_conditions/lower_adj.csv')
colnames(all_upper_CIs) <- paste0('upper_', colnames(all_upper_CIs))
colnames(all_lower_CIs) <- paste0('lower_', colnames(all_lower_CIs))

# plot LV1
all_LV1 <- select(all_mean, category, superordinate, LV1)
all_LV1$upper <- all_upper_CIs$upper_LV1
all_LV1$lower <- all_lower_CIs$lower_LV1
all_LV1$category <- factor(all_LV1$category,levels=plotting_categories)
LV1_tbs <- read.csv('data/PLS/mean-centered/all_conditions/LV1_tbs.csv')
LV1_tbs$subID <- rep(1:27, each = 8)
LV1_tbs$category <- matlab_categories
LV1_tbs <- pivot_longer(LV1_tbs, cols = starts_with('Lag'), names_to = 'lag', values_to = 'score')
p1 <- brain_scores(all_LV1, ~LV1, '') + MFT_color() + MFT_fill()
p2 <- temporal_brain_scores(LV1_tbs) + MFT_color() + MFT_fill()
p1 + p2 +
  plot_layout(ncol = 2, nrow = 1, widths = c(1.95, 0.95), guides = 'collect') +
  plot_annotation(title = '') &
  theme(text = element_text(family = 'Times New Roman'), plot.tag = element_text(size = 11), plot.title = element_text(hjust=0.5))
ggsave('figures/paper/plot_LV1.png', width = 11, height = 3)


# plot LV2
all_LV2 <- select(all_mean, category, superordinate, LV2)
all_LV2$upper <- all_upper_CIs$upper_LV2
all_LV2$lower <- all_lower_CIs$lower_LV2
all_LV2$category <- factor(all_LV2$category, levels=plotting_categories)
LV2_tbs <- read.csv('data/PLS/mean-centered/all_conditions/LV2_tbs.csv')
LV2_tbs$subID <- rep(1:27, each = 8)
LV2_tbs$category <- matlab_categories
LV2_tbs <- pivot_longer(LV2_tbs, cols = starts_with('Lag'), names_to = 'lag', values_to = 'score')
p3 <- brain_scores(all_LV2, ~LV2, '') + MFT_color() + MFT_fill() 
p4 <- temporal_brain_scores(LV2_tbs) + MFT_color() + MFT_fill() 
p3 + p4 +
  plot_layout(ncol = 2, nrow = 1, widths = c(1.95, 0.95), guides = 'collect') +
  plot_annotation(title = '') &
  theme(text = element_text(family = 'Times New Roman'), plot.tag = element_text(size = 11), plot.title = element_text(hjust=0.5))
ggsave('figures/paper/plot_LV2.png', width = 11, height = 3)


# plot LV3
all_LV3 <- select(all_mean, category, superordinate, LV3)
all_LV3$upper <- all_upper_CIs$upper_LV3
all_LV3$lower <- all_lower_CIs$lower_LV3
all_LV3$category <- factor(all_LV3$category, levels=plotting_categories)
LV3_tbs <- read.csv('data/PLS/mean-centered/all_conditions/LV3_tbs.csv')
LV3_tbs$subID <- rep(1:27, each = 8)
LV3_tbs$category <- matlab_categories
LV3_tbs <- pivot_longer(LV3_tbs, cols = starts_with('Lag'), names_to = 'lag', values_to = 'score') 
p5 <- brain_scores(all_LV3, ~LV3, '') + MFT_color() + MFT_fill()
p6 <- temporal_brain_scores(LV3_tbs) + MFT_color() + MFT_fill() 
p5 + p6 +
  plot_layout(ncol = 2, nrow = 1, widths = c(1.95, 0.95), guides = 'collect') +
  plot_annotation(title = '') &
  theme(text = element_text(family = 'Times New Roman'), plot.tag = element_text(size = 11), plot.title = element_text(hjust=0.5))
ggsave('figures/paper/plot_LV3_new.png', width = 11, height = 3)

#### dropping social norms ####
# pc <- c('Authority', 'Loyalty', 'Purity', 'Harm-Emo', 'Harm-Phys', 'Fairness', 'Liberty')
# mc <- c('Authority', 'Harm-Emo', 'Harm-Phys', 'Fairness', 'Liberty', 'Loyalty', 'Purity')
# new_colors <- c('#c40233', '#E60026','#ea3c53', '#2b8cd6', '#86b1e4','#bfd2f2','#7CAE00')
# viz_palette(new_colors)
# fdns_color <- get_scale_color(get_pal(new_colors))
# fdns_fill <- get_scale_fill(get_pal(new_colors))
# 
# # prep main df
# fdns_mean <- read.csv('data/PLS/mean-centered/just_foundations/means_fdns.csv')
# fdns_mean$category <- mc
# fdns_mean$superordinate <- superordinateCategory(fdns_mean$category)
# fdns_upper_CIs <- read.csv('data/PLS/mean-centered/just_foundations/upper_fdns.csv')
# fdns_lower_CIs <- read.csv('data/PLS/mean-centered/just_foundations/lower_fdns.csv')
# colnames(fdns_upper_CIs) <- paste0('upper_', colnames(fdns_upper_CIs))
# colnames(fdns_lower_CIs) <- paste0('lower_', colnames(fdns_lower_CIs))
# 
# # plot LV1
# fdns_LV1 <- select(fdns_mean, category, superordinate, LV1)
# fdns_LV1$upper <- fdns_upper_CIs$upper_LV1
# fdns_LV1$lower <- fdns_lower_CIs$lower_LV1
# fdns_LV1$category <- factor(fdns_LV1$category, levels=pc)
# fdns_LV1_tbs <- read.csv('data/PLS/mean-centered/just_foundations/LV1_tbs_fdns.csv')
# fdns_LV1_tbs$subID <- rep(1:27, each = 7)
# fdns_LV1_tbs$category <- mc
# fdns_LV1_tbs <- pivot_longer(fdns_LV1_tbs, cols = starts_with('Lag'), names_to = 'lag', values_to = 'score')
# p5 <- brain_scores(fdns_LV1, ~LV1, 'LV1: 28.39% crossblock variance, p<0.002') + fdns_color() + fdns_fill()
# p6 <- temporal_brain_scores(fdns_LV1_tbs) + fdns_color() + fdns_fill()
# p5 + p6 +
#   plot_layout(ncol = 2, nrow = 2, widths = c(2, 0.95), guides = 'collect') +
#   plot_annotation(title = '') &
#   theme(text = element_text(family = 'Times New Roman'), plot.tag = element_text(size = 11), plot.title = element_text(hjust=0.5))
# 
# # plot LV2
# fdns_LV2 <- select(fdns_mean, category, superordinate, LV2)
# fdns_LV2$upper <- fdns_upper_CIs$upper_LV2
# fdns_LV2$lower <- fdns_lower_CIs$lower_LV2
# fdns_LV2$category <- factor(fdns_LV2$category,levels=pc)
# fdns_LV2_tbs <- read.csv('data/PLS/mean-centered/just_foundations/LV2_tbs_fdns.csv')
# fdns_LV2_tbs$subID <- rep(1:27, each = 7)
# fdns_LV2_tbs$category <- mc
# fdns_LV2_tbs <- pivot_longer(fdns_LV2_tbs, cols = starts_with('Lag'), names_to = 'lag', values_to = 'score')
# p7 <- brain_scores(fdns_LV2, ~LV2, 'LV2: 25.01% crossblock variance, p<0.010') + fdns_fill() + fdns_color()
# p8 <- temporal_brain_scores(fdns_LV2_tbs) + fdns_color() + fdns_fill()
# p7 + p8 +
#   plot_layout(ncol = 2, nrow = 2, widths = c(2, 0.95), guides = 'collect') +
#   plot_annotation(title = '') &
#   theme(text = element_text(family = 'Times New Roman'), plot.tag = element_text(size = 11), plot.title = element_text(hjust=0.5))
```


# non-rotated PLS plots
```{r non-rotated plots}
# load all data
nr_means <- read.csv('data/PLS/non-rotated/nr_means.csv', header = FALSE)
nr_upper <- read.csv('data/PLS/non-rotated/nr_upper.csv', header = FALSE)
nr_lower <- read.csv('data/PLS/non-rotated/nr_lower.csv', header = FALSE)
nr_means$category <- matlab_categories
nr_means$category <- factor(nr_means$category, levels = plotting_categories)
colnames(nr_upper) <- paste0('upper_', colnames(nr_upper))
colnames(nr_lower) <- paste0('lower_', colnames(nr_lower))

# social norms contrast
nr_social <- nr_means %>% select(category, V2)
nr_social$upper <- nr_upper$upper_V2
nr_social$lower <- nr_lower$lower_V2
# temporal brain scores
nr_social_tbs <- read.csv('data/PLS/non-rotated/socialnorms_tbs.csv', header=FALSE)
colnames(nr_social_tbs) <- c('Lag0', 'Lag1', 'Lag2','Lag3', 'Lag4', 'Lag5', 'Lag6')
nr_social_tbs$subID <- rep(dataSubs, each = 8)
nr_social_tbs$category <- matlab_categories 
nr_social_tbs <- pivot_longer(nr_social_tbs, cols = starts_with('Lag'), names_to = 'lag', values_to = 'score')
# plot
p7 <- brain_scores(nr_social, ~V2, '') + MFT_color() + MFT_fill()
p8 <- temporal_brain_scores(nr_social_tbs) + MFT_color() + MFT_fill()
p7 + p8 +
  plot_layout(ncol = 2, nrow = 1, widths = c(1.95, 0.95), guides = 'collect') +
  plot_annotation(title = '') &
  theme(text = element_text(family = 'Times New Roman'), plot.tag = element_text(size = 11),
        plot.title =element_text(hjust=0.5))
ggsave('figures/paper/plot_NRsocial.png', width = 11, height = 3)

  
# superordinate contrast - all foundations (not including plot in paper)
nr_sup <- nr_means %>% select(category, V1)
nr_sup$upper <- nr_upper$upper_V1
nr_sup$lower <- nr_lower$lower_V1
# temporal brain scores
nr_sup_tbs <- read.csv('data/PLS/non-rotated/superordinate_tbs.csv', header=F)
colnames(nr_sup_tbs) <- c('Lag0', 'Lag1', 'Lag2','Lag3', 'Lag4', 'Lag5', 'Lag6')
nr_sup_tbs$subID <- rep(dataSubs, each = 8)
nr_sup_tbs$category <- matlab_categories 
nr_sup_tbs <- pivot_longer(nr_sup_tbs, cols = starts_with('Lag'), names_to = 'lag', values_to = 'score')

p9 <- brain_scores(nr_sup, ~V1, '') + MFT_color() + MFT_fill()
p10 <- temporal_brain_scores(nr_sup_tbs) + MFT_color() + MFT_fill()

p9 + p10 +
  plot_layout(ncol = 2, nrow = 1, widths = c(1.95, 0.95), guides = 'collect') +
  plot_annotation(title = '') &
  theme(text = element_text(family = 'Times New Roman'), plot.tag = element_text(size = 11), 
        plot.title =element_text(hjust=0.5))
ggsave('figures/paper/plot_NRsup.png', width = 11, height = 3)


# superordinate NR with Authority & Social Norms = 0
nr_auth0 <- read.csv('data/PLS/non-rotated/nr_superordinate_auth0_means.csv', header = F) 
nr_auth0$upper <- read.csv('data/PLS/non-rotated/nr_superordinate_auth0_upper.csv', header = F) %>% unlist()
nr_auth0$lower <- read.csv('data/PLS/non-rotated/nr_superordinate_auth0_lower.csv', header = F) %>% unlist()
nr_auth0$category <- c('Authority', 'Harm-Emo', "Harm-Phys", "Fairness",'Loyalty', 'Purity') %>%
  factor(., levels = c('Authority', 'Loyalty', 'Purity', 'Harm-Emo', 'Harm-Phys', 'Fairness'))
# temporal brain scores
nr_auth0_tbs <- read.csv('data/PLS/non-rotated/nr_superordinate_auth0_tbs.csv', header=F)
colnames(nr_auth0_tbs) <- c('Lag0', 'Lag1', 'Lag2','Lag3', 'Lag4', 'Lag5', 'Lag6')
nr_auth0_tbs$subID <- rep(dataSubs, each = 6)
nr_auth0_tbs$category <- c('Authority', 'Harm-Emo', "Harm-Phys", "Fairness",'Loyalty', 'Purity')
nr_auth0_tbs <- pivot_longer(nr_auth0_tbs, cols = starts_with('Lag'), names_to = 'lag', values_to = 'score')

# hard code the plots
p11 <- ggplot(nr_auth0, aes(x=category, y=V1, fill=category)) +
    geom_hline(aes(yintercept = 0), size = 0.5) +
    labs(y = 'Brain scores', x = 'Foundation') +
    geom_col(color='black') + 
    geom_point(color='black', size=1) +
    geom_errorbar(aes(ymax = upper, ymin = lower), color='black', size=0.5, width=0.25) +
    scale_fill_manual(values = c('#c40233', '#E60026','#ea3c53', '#2b8cd6', '#86b1e4','#bfd2f2')) +
    scale_x_discrete(labels = c('Auth.', 'Loy.','Pur.', 'Harm-E.', "Harm-P.", "Fair.")) +
    theme_pubr(legend = 'none') +
    theme(axis.title.x = element_blank(),
          axis.title.y = element_text(size=14),
          axis.text = element_text(size = 14),
          plot.title = element_text(hjust = 0.5, size = 16))

p12 <- lmer(score ~ lag * category + (1 | subID), data = nr_auth0_tbs) %>%
    emmeans(~ lag * category) %>% as.data.frame() %>%
    mutate(category = factor(category, levels = c('Authority', 'Loyalty', 'Purity', 'Harm-Emo', 'Harm-Phys', 'Fairness'))) %>%
    ggplot(aes(x=lag, y=emmean, group=category, color=category, fill=category))  + 
    scale_x_discrete(expand = c(0, 0, 0, 0.1), labels = c('TR1', 'TR2', 'TR3', 'TR4', 'TR5', 'TR6', 'TR7')) +
    geom_hline(aes(yintercept = 0), size=1) +
    geom_line(size=1) + 
    geom_point(aes(fill=category, color=category, shape = category), size=3) +
    scale_shape_manual(values = c(4,15,16,17,0,1,2, 3)) +
    scale_color_manual(values = c('#c40233', '#E60026','#ea3c53', '#2b8cd6', '#86b1e4','#bfd2f2')) +
    theme_pubr(legend = 'right') +
    theme(axis.title.x = element_blank(),
          axis.title.y = element_text(size=14), 
          axis.text = element_text(size = 14)) +
    labs(y = 'Temporal brain scores', color='Foundation', fill='Foundation', shape='Foundation')

p11 + p12 +  
  plot_layout(ncol = 2, nrow = 1, widths = c(1.95, 0.95), guides = 'collect') &
  theme(text = element_text(family = 'Times New Roman'), plot.tag = element_text(size = 11))
ggsave('figures/paper/plot_NRLV2.png', width = 11, height = 3)
```

# compare our sample to normed data
```{r norm comparison, message=FALSE, warning=FALSE, include=FALSE}
mfv <- read.csv('data/mfv_norms.csv')
mfv$moral_decision <- scale(mfv$moral_decision, center = T)
mfv$dataset <- 'Normed'
mfv$category <- factor(mfv$category, levels = c('Social Norms', 'Authority', 'Loyalty', 'Sanctity',
                                                 'Harm-Phys', 'Harm-Emo', 'Fairness', 'Liberty'),
                       labels = c('Social Norms', 'Authority', 'Loyalty', 'Purity',
                                                 'Harm-Phys', 'Harm-Emo', 'Fairness', 'Liberty'))

mfv_comp <- data_old %>% select(category, vigfile, vignette, subID, moral_decision) %>%
  mutate(moral_decision = scale(moral_decision, center = T)) %>%
  group_by(vigfile) %>%
  summarise(moral_decision = mean(moral_decision)) %>%
  mutate(category = assignCategory(vigfile))
mfv_comp$dataset <- 'Ours'
mfv_moral <- mfv %>% mutate(moral_decision = scale(moral_decision)) %>% select(category, moral_decision, vigfile)
mfv_moral$dataset <- 'Normed'

mfv_comp <- rbind(mfv_comp, mfv_moral) %>% mutate(vigfile = factor(vigfile),
                                            category = factor(category, levels = plotting_categories))

normCheck <- lmer(moral_decision ~ dataset*category + (1|vigfile), data = mfv_comp,
                  contrasts = list(category=contr.sum))
summary(normCheck)

# compute effect size
emmeans(normCheck, ~ dataset*category) %>% 
  contrast(interaction=c('revpairwise', 'eff')) %>%
  eff_size(sigma = sd(mfv_comp$moral_decision), edf = df.residual(normCheck), method = 'identity') %>%
  as.data.frame() %>% 
  mutate(effect.size = round(effect.size, 2)) %>% 
  write.csv(file = 'figures/paper/table_normCheck_eff.csv')

emmeans(normCheck, ~ category) %>% 
  contrast(interaction=c('eff')) %>%
  eff_size(sigma = sd(mfv_comp$moral_decision), edf = df.residual(normCheck), method = 'identity') %>%
  as.data.frame() %>% 
  mutate(effect.size = round(effect.size, 2)) %>% 
  write.csv(file = 'figures/paper/table_normCheck_effCategory.csv')

emmeans(normCheck, ~ dataset) %>% 
  contrast(interaction=c('eff')) %>%
  eff_size(sigma = sd(mfv_comp$moral_decision), edf = df.residual(normCheck), method = 'identity') %>%
  as.data.frame() %>% 
  mutate(effect.size = round(effect.size, 2)) %>% 
  write.csv(file = 'figures/paper/table_normCheck_effDataset.csv')

# make pretty table
tab_model(normCheck, 
          file = 'figures/paper/table_normCheck.html',  
          digits = 2, 
          show.ci = 0.95, show.stat = TRUE, show.p = TRUE, show.ngroups = TRUE, show.df = TRUE,
          p.val = 'satterthwaite', 
          strings = c(stat = 't value', ci = 'CI (95%)', pred = 'Factors', p = 'p value'),
          dv.labels = 'moral judgment', 
          col.order = c('est','ci','df.error','stat','p'),
          pred.labels = c('Intercept (Grand Mean)', 'Our sample',
                          'Social Norms', 'Authority', 'Loyalty', 'Purity', 'Harm-Emo', 'Harm-Phys', 'Fairness',
                          'Our sample*Social Norms', 'Our sample*Authority', 'Our sample*Loyalty', 'Our sample*Purity',
                          'Our sample*Harm-Emo', 'Our sample*Harm-Phys', 'Our sample*Fairness'))

# plot
as.data.frame(emmeans(normCheck, ~ dataset*category)) %>%
  mutate(dataset = factor(dataset, labels = c('Normed data', 'Our sample'))) %>%
  ggplot(aes(x = category, y = emmean, color = dataset, fill = dataset)) +
  geom_pointrange(aes(ymin = lower.CL, ymax = upper.CL), position = position_dodge(0.5)) +
  labs(y = 'Estimated mean moral judgment (z-scored)', title = 'Comparison to Clifford et al. (2015)', color=NULL, fill=NULL) +
  scale_color_manual(values=c('black', 'gray70')) +
  theme_pubr(base_family = 'Times New Roman', legend = 'right') +
  theme(axis.title.x = element_blank(),
        plot.title = element_text(hjust = 0.5)) 
ggsave('figures/paper/plot_normComparison.png', width=9, height=3)

# take out social norms -- dataset interactions all go away
normCheck2 <- mfv_comp %>% filter(category != 'Social Norms') %>%
  lm(moral_decision ~ dataset*category, .)
summary(normCheck2)
as.data.frame(emmeans(normCheck2, ~ dataset*category)) %>%
  ggplot(aes(x = category, y = emmean, color = dataset, fill = dataset)) +
  geom_pointrange(aes(ymin = lower.CL, ymax = upper.CL), position = position_dodge(0.5)) +
  labs(y = 'Estimated mean moral judgment (z-scored)', title = 'Comparison to Clifford et al. (2015)') +
  theme_pubr(base_family = 'Times New Roman', legend = 'right') +
  theme(axis.title.x = element_blank(),
        plot.title = element_text(hjust = 0.5))
ggsave('figures/paper/plot_CliffComparison.png', dpi = 300, width = 10, height = 5.5)
```


# moral judgment model & plot
```{r moral judgment analysis & plots}
## modelMoral 
modelMoral <- lmer(moral_decision ~ category + (1|subID) + (1|vigfile), data = data_old)

# write table
tab_model(modelMoral, 
          #file = 'figures/paper/table_modelMoral.html',  
          digits = 2, 
          show.ci = 0.95, show.stat = TRUE, show.p = TRUE, show.ngroups = TRUE, show.df = TRUE,
          p.val = 'satterthwaite', 
          strings = c(stat = 't value', ci = 'CI (95%)', pred = 'Factors', p = 'p value'),
          dv.labels = 'moral judgment', 
          col.order = c('est','ci','df.error','stat','p'),
          pred.labels = c('Intercept (Social Norms)', 
                          'Authority', 'Loyalty', 'Purity', 'Harm-Emo', 'Harm-Phys', 'Fairness', 'Liberty'))

# compute effect size
emmeans(modelMoral, ~ category) %>%
  eff_size(sigma = sd(data_old$moral_decision), edf = df.residual(modelMoral), method = 'trt.vs.ctrl') 

# plot 
modelMoral_df <- as.data.frame(emmeans(modelMoral, ~ category))
ggplot(modelMoral_df, aes(x=category, y=emmean)) +
  ylim(0.98,4) +
  labs(y='Estimated mean moral wrongness judgment') +
  scale_x_discrete(labels =c('S.N.', 'Auth.', 'Loy.', 'Pur.', 'Harm-E.', 'Harm-P.', 'Fair.', 'Lib.')) +
  geom_violin(data=data_old, mapping=aes(y=moral_decision, fill=category), alpha=0.85, bw=0.45) + 
  geom_pointrange(aes(ymin=lower.CL, ymax=upper.CL), alpha=1, fatten=5, color='black') +
  MFT_fill() + MFT_color() +
  theme_pubr(legend = 'none',
             base_family = 'Times New Roman',
             base_size = 20) +
  theme(axis.title.x = element_blank(),
        axis.text = element_text(size = 20),
        axis.title.y = element_text(size=18),
        legend.title = element_text(size = 18),
        legend.text = element_text(size = 18))
ggsave('figures/paper/plot_modelMoral.png', dpi=400, width = 10, height = 5.5)

# contrasts
supContrastMoral <- modelMoral %>% 
  emmeans(~ category) %>%
  contrast(SuperordinateContrasts, adjust = 'tukey')
supContrastMoral.eff <- eff_size(supContrastMoral, sigma = sd(data_old$moral_decision), edf = df.residual(modelMoral), method = 'identity') %>%
  as.data.frame() %>%
  mutate(effect.size = round(effect.size, 2))
supContrastMoral.df <- as.data.frame(supContrastMoral) %>%
  mutate_at(c('estimate', 'SE', 'df', 't.ratio'), funs(round(.,2)))
supContrastMoral.df$eff_size <- supContrastMoral.eff$effect.size 
write.csv(supContrastMoral.df, file = 'figures/paper/table_supContrastMoral.csv', row.names = F)

```

# superordinate model
```{r superordinate model}
# actually, we should just run a model to test superordinate differences
data_sup <- data_sup %>% mutate(MeanConservatism = scale(MeanConservatism))
modelSuperordinate <- lmer(moral_decision ~ superordinate*MeanConservatism + (1|subID) + (1|vigfile), data=data_sup)
conservatism_range <- function(conservatism, precision=0.5) {
  return(seq(min(data_sup[,conservatism], na.rm=TRUE),
             max(data_sup[,conservatism], na.rm=TRUE),
             precision))
}

emm_options(pbkrtest.limit = 3050) # to enable df calculations

conservatism_trends <- as.data.frame(emmeans(modelSuperordinate, ~ MeanConservatism | superordinate, at=list(conservatism=conservatism_range('MeanConservatism'))))
conservatism_effect <- as.data.frame(emmeans(modelSuperordinate, ~ MeanConservatism, at=list(conservatism=conservatism_range('MeanConservatism'))))
conservatism.emt <- emtrends(modelSuperordinate, ~ superordinate, 'MeanConservatism')

# effect size for simple main effects
emmeans(modelSuperordinate, ~ superordinate, at=list(MeanConservatism=c(0, 1))) %>%
  eff_size(sigma = sd(data_sup$MeanConservatism), edf = df.residual(modelSuperordinate), method = 'eff')
emmeans(modelSuperordinate, ~ MeanConservatism, at=list(MeanConservatism=c(0, 1))) %>%
  eff_size(sigma = sd(data_sup$MeanConservatism), edf = df.residual(modelSuperordinate), method = 'revpairwise')

# effect size for interactions
emmeans(modelSuperordinate, ~ MeanConservatism * superordinate, at=list(MeanConservatism=c(0,1))) %>%
  contrast(interaction=c('revpairwise', 'eff')) %>%
  eff_size(sigma = sd(data_sup$MeanConservatism), edf = df.residual(modelSuperordinate), method = 'identity')

tab_model(modelSuperordinate, 
          file = 'figures/paper/table_modelSuperordinate.html',  
          digits = 2, 
          show.ci = 0.95, show.stat = TRUE, show.p = TRUE, show.ngroups = TRUE, show.df = TRUE,
          p.val = 'satterthwaite', 
          strings = c(stat = 't value', ci = 'CI (95%)', pred = 'Factors', p = 'p value'),
          dv.labels = 'moral judgment', 
          col.order = c('est','ci','df.error','stat','p'),
          pred.labels = c('Intercept (Social Norms)', 
                          'Liberty', 'Individualizing', 'Binding', 'Conservatism',
                          'Liberty*Conservatism', 'Individualizing*Conservatism', 'Binding*Conservatism'))



# without liberty
data_sup <- data_sup %>% filter(superordinate != 'Liberty')
modelSuperordinate <- lmer(moral_decision ~ superordinate*scale(MeanConservatism) + (1|subID) + (1|vigfile), data=data_sup)
conservatism_range <- function(conservatism, precision=0.5) {
  return(seq(min(data_sup[,conservatism], na.rm=TRUE),
             max(data_sup[,conservatism], na.rm=TRUE),
             precision))
}

conservatism_trends <- as.data.frame(emmeans(modelSuperordinate, ~ MeanConservatism | superordinate, at=list(conservatism=conservatism_range('MeanConservatism'))))
conservatism_effect <- as.data.frame(emmeans(modelSuperordinate, ~ MeanConservatism, at=list(conservatism=conservatism_range('MeanConservatism'))))
conservatism.emt <- emtrends(modelSuperordinate, ~ superordinate, 'MeanConservatism')

emmeans(modelSuperordinate, ~ superordinate, at=list(MeanConservatism=c(0, 1))) %>%
  eff_size(sigma = sd(data_sup$MeanConservatism), edf = df.residual(modelSuperordinate), method = 'eff')

emmeans(modelSuperordinate, ~ MeanConservatism, at=list(MeanConservatism=c(0, 1))) %>%
  eff_size(sigma = sd(data_sup$MeanConservatism), edf = df.residual(modelSuperordinate), method = 'revpairwise')
```




```{r emotion analyses}
# load data
emotion_ratings <- read.csv('data/behavior/qualtrics/emotion_ratings.csv', stringsAsFactors = FALSE)
emotion_ratings[2:30, 2:721] <- as.data.frame(sapply(emotion_ratings[2:30, 2:721], function(s) substr(s, 1, 2)), stringsAsFactors = FALSE)
names(emotion_ratings)[1] <- 'subID'
emotion_ratings <- emotion_ratings[2:nrow(emotion_ratings),] %>% pivot_longer(2:ncol(emotion_ratings), names_to=c('vigfile', 'emotion'), names_pattern='([a-z]+\\d+)\\.*(.*)' , values_to='emoresp')
emotion_ratings$emotion[emotion_ratings$emotion == ''] = 'angry'
emotion_ratings$emotion[emotion_ratings$emotion == '1'] = 'sad'
emotion_ratings$emotion[emotion_ratings$emotion == '2'] = 'disgusted'
emotion_ratings$emotion[emotion_ratings$emotion == '3'] = 'afraid'
emotion_ratings$emotion[emotion_ratings$emotion == '4'] = 'contemptuous'
emotion_ratings$emotion[emotion_ratings$emotion == '5'] = 'amused'
emotion_ratings$emoresp <- as.numeric(emotion_ratings$emoresp)
emotion_ratings <- subset(emotion_ratings, subID != c('20', '35', '36'))
emotion_ratings$category <- assignCategory(emotion_ratings$vigfile)
emotion_ratings$category <- factor(emotion_ratings$category, levels = plotting_categories)

# make dataframes for analyses
emo_df <- pivot_wider(emotion_ratings, names_from = emotion, values_from = emoresp)
emo_df <- left_join(data_old, emo_df, by = c('subID', 'vigfile', 'category')) %>%
  drop_na(c(angry, sad, disgusted, afraid, contemptuous, amused))

# visualize variable correlations
emotion_scores <- na.omit(emo_df[,19:24])
corr <- cor(emotion_scores)
ggcorrplot(corr, lab = TRUE) # perhaps we should drop contemptuous from the analysis
# ggsave('emo_corr_matrix.png')


# # arousal analysis
# arousal_range <- function(arousal, precision=0.5) {
#   return(seq(min(data_old[,arousal], na.rm=TRUE),
#              max(data_old[,arousal], na.rm=TRUE),
#              precision))
# }
# 
# modelMoral_arousal <- lmer(moral_decision ~ category*arousal + (1|subID) + (1|vigfile), data=data_old, 
#                            contrasts = list(category=contr.sum))
# 
# arousal_trends <- as.data.frame(emmeans(modelMoral_arousal, ~ arousal | category, at=list(arousal=arousal_range('arousal'))))
# arousal_effect <- as.data.frame(emmeans(modelMoral_arousal, ~ arousal, at=list(arousal=arousal_range('arousal'))))
# arousal.emt <- emtrends(modelMoral_arousal, ~ category, 'arousal')
# 
# emmeans(modelMoral_arousal, ~ category, at=list(arousal=c(0, 1))) %>%
#   eff_size(sigma = sd(data_old$arousal), edf = df.residual(modelMoral_arousal), method = 'eff')
# 
# emmeans(modelMoral_arousal, ~ arousal, at=list(arousal=c(0, 1))) %>%
#   eff_size(sigma = sd(data_old$arousal), edf = df.residual(modelMoral_arousal), method = 'revpairwise')
#   
# # plot
# ggplot(arousal_trends, aes(x=arousal, y=emmean,ymin=lower.CL, ymax=upper.CL)) +
#   geom_hline(yintercept = 1.5, linetype='dashed') + 
#   geom_line(data = arousal_effect) +
#   geom_ribbon(data = arousal_effect, alpha = 0.2) +
#   geom_line(aes(color=category)) +
#   geom_ribbon(aes(fill=category), alpha=0.3) +
#   facet_grid(. ~ category) +
#   MFT_color() + MFT_fill() +
#   theme_pubr(legend = 'none') +
#   labs(y='Estimated moral judgment', x='Arousal') + 
#   theme(strip.text = element_text(face = 'bold', size = 12))
# ggsave('figures/arousal.png', dpi = 300, width = 13, height = 4)
# contrast(arousal.emt, adjust = 'none')
# 
# # arousal analysis with normed data
# arousal_norm_range <- function(arousal, precision=0.5) {
#   return(seq(min(mfv[,arousal], na.rm=TRUE),
#              max(mfv[,arousal], na.rm=TRUE),
#              precision))
# }
# modelMoral_norm <- lm(moral_decision ~ category*arousal, data=mfv, contrasts = list(category=contr.sum))
# arousal_norm_trends <- as.data.frame(emmeans(modelMoral_norm, ~ arousal | category, at=list(arousal=arousal_norm_range('arousal'))))
# arousal_norm_effect <- as.data.frame(emmeans(modelMoral_norm, ~ arousal, at=list(arousal=arousal_norm_range('arousal'))))
# arousal_norm.emt <- emtrends(modelMoral_norm, ~ category, 'arousal')
# 
# ggplot(arousal_norm_trends, aes(x=arousal, y=emmean,ymin=lower.CL, ymax=upper.CL)) +
#   geom_hline(yintercept = 1.2, linetype='dashed') + 
#   geom_line(data = arousal_norm_effect) +
#   geom_ribbon(data = arousal_norm_effect, alpha = 0.2) +
#   geom_line(aes(color=category)) +
#   geom_ribbon(aes(fill=category), alpha=0.3) +
#   facet_grid(. ~ category) +
#   MFT_color() + MFT_fill() +
#   theme_pubr(legend = 'none') +
#   labs(y='Estimated moral judgment', x='Arousal', title='Estimates using normed data') + 
#   theme(strip.text = element_text(face = 'bold', size = 12),
#         plot.title = element_text(hjust = 0.5))
# ggsave('figures/arousal_norm.png', dpi = 300, width = 13, height = 4)
# contrast(arousal_norm.emt, adjust = 'none')
# 
# emmeans(modelMoral_norm, ~ category, at=list(arousal=c(0, 1))) %>%
#   eff_size(sigma = sd(mfv$arousal), edf = df.residual(modelMoral_norm), method = 'eff')
# 
# emmeans(modelMoral_norm, ~ arousal, at=list(arousal=c(0, 1))) %>%
#   eff_size(sigma = sd(mfv$arousal), edf = df.residual(modelMoral_norm), method = 'pairwise')
```

# emotion model comparisons
```{r em model comparison}
# baseline: no fixed effects
em_null_moral <- lmer(moral_decision ~ 1 + (1|subID) + (1|vigfile), data = emo_df) 

# standard: category as fixed effect
em_modelMoral <- lmer(moral_decision ~ category + (1|subID) + (1|vigfile), data = emo_df, contrasts = list(category=contr.sum))

# just emotions as fixed effects
em_only_moral <- lmer(moral_decision ~ angry + sad + disgusted + afraid + contemptuous + amused +
                        (1|subID) + (1|vigfile), data=emo_df)

# add emotion to foundations
em_add_moral <- lmer(moral_decision ~ category + angry + sad + disgusted + afraid + contemptuous + amused +
                        (1|subID) + (1|vigfile), data=emo_df, contrasts = list(category=contr.sum))
# see if emotion effects hold up when removing social norms -- they do 
em_add_moral2 <- emo_df %>% filter(category != 'Social Norms') %>%
  lmer(moral_decision ~ category + angry + sad + disgusted + afraid + contemptuous + amused +
                        (1|subID) + (1|vigfile), ., contrasts = list(category=contr.sum))

# each emotion interacts with category
em_int_moral <- lmer(moral_decision ~ 
                        category * angry + 
                        category * sad + 
                        category * disgusted + 
                        category * afraid + 
                        category * contemptuous + 
                        category * amused + 
                        (1|subID) + (1|vigfile), data = emo_df,
                    contrasts = list(category=contr.sum))

em_comp_moral.df <- compare_performance(em_null_moral, em_modelMoral, em_only_moral, em_add_moral, em_int_moral,
                                        bayesfactor = FALSE, rank = TRUE) %>% 
  as.data.frame() %>% 
  mutate(AIC = round(AIC, 2),
         BIC = round(BIC, 2),
         R2_conditional = round(R2_conditional, 2),
         R2_marginal = round(R2_marginal, 2),
         ICC = round(ICC, 2),
         RMSE = round(RMSE, 2)) %>%
  select(-Type)
write.csv(em_comp_moral.df, file = 'figures/paper/table_emCompMoral.csv', row.names = F)
summary(em_add_moral)
```

# emotion comparisons without authority
```{r}
emo_df2 <- emo_df %>% filter(category != 'Authority')
# baseline: no fixed effects
em_null_moral <- lmer(moral_decision ~ 1 + (1|subID) + (1|vigfile), data = emo_df2) 

# standard: category as fixed effect
em_modelMoral <- lmer(moral_decision ~ category + (1|subID) + (1|vigfile), data = emo_df2, contrasts = list(category=contr.sum))

# just emotions as fixed effects
em_only_moral <- lmer(moral_decision ~ angry + sad + disgusted + afraid + contemptuous + amused +
                        (1|subID) + (1|vigfile), data=emo_df2)

# add emotion to foundations
em_add_moral <- lmer(moral_decision ~ category + angry + sad + disgusted + afraid + contemptuous + amused +
                        (1|subID) + (1|vigfile), data=emo_df2, contrasts = list(category=contr.sum))

# see if emotion effects hold up when removing social norms -- they do 
# em_add_moral2 <- emo_df %>% filter(category != 'Social Norms') %>%
#   lmer(moral_decision ~ category + angry + sad + disgusted + afraid + contemptuous + amused +
#                         (1|subID) + (1|vigfile), ., contrasts = list(category=contr.sum))

# each emotion interacts with category
em_int_moral <- lmer(moral_decision ~ 
                        category * angry + 
                        category * sad + 
                        category * disgusted + 
                        category * afraid + 
                        category * contemptuous + 
                        category * amused + 
                        (1|subID) + (1|vigfile), data = emo_df2,
                    contrasts = list(category=contr.sum))

em_comp_moral.df2 <- compare_performance(em_null_moral, em_modelMoral, em_only_moral, em_add_moral, em_int_moral,
                                        bayesfactor = FALSE, rank = TRUE)


```
# Summarize em_add_moral
```{r sum-code em_category, include = FALSE}
# make pretty table
tab_model(em_add_moral,
          file = 'figures/paper/table_emAddMoral.html',
          digits = 2, 
          show.ci = 0.95, show.stat = TRUE, show.p = TRUE, show.ngroups = TRUE, show.df = TRUE,
          p.val = 'satterthwaite', 
          strings = c(stat = 't value', ci = 'CI (95%)', pred = 'Factors', p = 'p value'),
          dv.labels = 'moral judgment', 
          col.order = c('est','ci','df.error','stat','p'),
          pred.labels = c('Intercept',
                          'Social Norms', 'Authority', 'Loyalty', 'Purity', 'Harm-Emo', 'Harm-Phys', 'Fairness', 
                          'Anger', 'Sadness', 'Disgust', 'Fear','Contempt','Amusement'))

# compute effect size 
emmeans(em_add_moral, ~ category) %>% 
  eff_size(sigma=sd(em_compare$moral_decision), edf=df.residual(em_add_moral), method='eff')

em_add.cov <- list(angry=0, amused=0, sad=0, afraid=0, contemptuous=0, disgusted=0,
                        PersonalDistressScore=0, EmpathicConcernScore=0,
                        PerspectiveTakingScore=0, FantasyScore=0)

em_add_effsize <- function(model, dv, em_measure) {
   arglist <- list(em_add.cov, c(0,1))
   names(arglist) <- c('.x', em_measure)
   return(emmeans(model, as.formula(paste0('~', em_measure)),
                  at=do.call(list_modify, arglist)) %>%
     eff_size(sigma=sd(em_compare[,c(dv)]), edf=df.residual(model), method='revpairwise'))
}

em_add_effsize(em_add_moral, 'moral_decision', 'angry')
em_add_effsize(em_add_moral, 'moral_decision', 'sad')
em_add_effsize(em_add_moral, 'moral_decision', 'disgusted')
em_add_effsize(em_add_moral, 'moral_decision', 'afraid')
em_add_effsize(em_add_moral, 'moral_decision', 'contemptuous')
em_add_effsize(em_add_moral, 'moral_decision', 'amused')
em_add_effsize(em_add_moral, 'moral_decision', 'PersonalDistressScore')
em_add_effsize(em_add_moral, 'moral_decision', 'EmpathicConcernScore')
em_add_effsize(em_add_moral, 'moral_decision', 'PerspectiveTakingScore')
em_add_effsize(em_add_moral, 'moral_decision', 'FantasyScore')

### MEMORY
eff_size(sigma=sd(emo_df$moral_decision), edf=df.residual(em_add_moral), method='eff')
moral_sd <- sd(emo_df$moral_decision)
moral_anger_eff <- 1.255e-01/moral_sd
moral_sad_eff <- 1.924e-02/moral_sd
moral_disgust_eff <- 1.600e-01/moral_sd
moral_fear_eff <- 1.057e-04/moral_sd
moral_contempt_eff <- 7.254e-02/moral_sd
moral_amused_eff <- -9.659e-02/moral_sd

# get npar
anova(em_null_moral, em_modelMoral, em_only_moral, em_add_moral, em_int_moral)

# plot
plot_moral_emo <- function(emotion, title) {
  as.data.frame(emmeans(em_add_moral, as.formula(paste0('~', emotion)), cov.reduce=range)) %>%
  ggplot(., aes_string(x=emotion, y='emmean', ymin='lower.CL', ymax='upper.CL')) +
    ylim(1, 4) + 
    geom_hline(yintercept=2.48, linetype='dashed', size=0.25) + 
    geom_line(size=1.25) +
    geom_ribbon(alpha=0.2) +
    labs(y='Moral judgment', x=paste(title, 'Score (scaled)'), title = title) +
    theme_pubr() + 
    theme(text = element_text(family = 'Times New Roman'),
          plot.title = element_text(hjust = 0.5, size=16, face = 'bold'))
}

anger_plot <- plot_moral_emo('angry', 'Anger')
sadness_plot <- plot_moral_emo('sad', 'Sadness')
disgust_plot <- plot_moral_emo('disgusted', 'Disgust')
fear_plot <- plot_moral_emo('afraid', 'Fear')
contempt_plot <- plot_moral_emo('contemptuous', 'Contempt')
amusement_plot <- plot_moral_emo('amused', 'Amusement')

anger_plot + sadness_plot + disgust_plot + fear_plot + contempt_plot + amusement_plot +
  plot_layout(ncol = 3, nrow = 2)
ggsave('figures/paper/plot_emAddMoral.png', width=8)
```


# memory accuracy model & plot
```{r, fig.width=20, fig.height=8, include=FALSE}
# generalized linear mixed effect model (outcome is binary)
modelMemory <- glmer(correct ~ category * old + (1 | subID) + (1|vigfile),
                     data=data, family = binomial(link = 'logit'), 
                     control=glmerControl(optimizer = 'bobyqa', 
                                          optCtrl = list(maxfun=1e9)),
                     contrasts = list(category=contr.sum))
summary(modelMemory)

modelMemory_betas <- as.data.frame((fixef(modelMemory)))
colnames(modelMemory_betas) <- 'beta'
modelMemory_betas <- modelMemory_betas %>% mutate(beta = round(beta, 2))
write.csv(modelMemory_betas, 'figures/paper/table_modelMemory_betas.csv')

# make pretty table
tab_model(modelMemory, 
          file = 'figures/paper/table_modelMemory.html',  
          digits = 2, 
          show.ci = 0.95, show.stat = TRUE, show.p = TRUE, show.ngroups = TRUE, show.df = TRUE,
          #p.val = 'satterthwaite', 
          strings = c(stat = 'z value', ci = 'CI (95%)', pred = 'Factors', p = 'p value'),
          dv.labels = 'correct', 
          col.order = c('est','ci','df.error','stat','p'),
          pred.labels = c('Intercept', 
                          'Social Norms', 'Authority', 'Loyalty', 'Purity', 'Harm-Emo', 'Harm-Phys', 'Fairness',
                          'New - Old', 'Individualizing Values',
                          'Social Norms*New', 'Authority*New', 'Loyalty*New', 'Purity*New', 'Harm-Emo*New', 'Harm-Phys*New','Fairness*New',
                          'Social Norms*IV', 'Authority*IV', 'Loyalty*IV', 'Purity*IV', 'Harm-Emo*IV', 'Harm-Phys*IV', 'Fairness*IV',
                          'New*Individualizing Values',
                          'Social Norms*New*IV', 'Authority*New*IV', 'Loyalty*New*IV', 'Purity*New*IV', 
                          'Harm-Emo*New*IV', 'Harm-Phys*New*IV','Fairness*New*IV'))

# plotting prep
data <- data %>% group_by(subID, category, old) %>% mutate(propCorrect = mean(correct)) # so that violin plots can reflect participant response densities
memLabels <- c('0' = "New", '1' = 'Old') # labels for faceting 

# plot
emmeans(modelMemory, ~ category*old, type = 'response') %>% as.data.frame %>%
  ggplot(aes(x=category, y=prob, fill=interaction(category,old))) +
  geom_violin(aes(x=category, y=propCorrect), data=data, alpha=0.85, scale='count', bw=.1) +
  geom_pointrange(aes(y=prob, ymax=asymp.LCL, ymin=asymp.UCL, shape=old), 
                  position = position_dodge(0.9), color='black', fatten=6) +
  scale_shape_manual(values = c(16,21), labels = c('Old', 'New')) +
  MFT_memfill() +
  scale_x_discrete(labels =c('S.N.', 'Auth.', 'Loy.', 'Pur.', 'Harm-E.', 'Harm-P.', 'Fair.', 'Lib.')) +
  theme_pubr(legend = 'top',
             base_family = 'Times New Roman',
             base_size = 15) +
  guides(fill=FALSE, shape=guide_legend(title=NULL)) +
  theme(plot.title = element_text(hjust = 0.5),
        legend.text = element_text(size = 20),
        axis.title.x = element_blank()) + 
  labs(y = 'Estimate probability of correct response', color = 'Old/New Status')
ggsave('figures/paper/plot_modelMemory.png', dpi = 'retina', width = 10)


# superordinate contrasts 
supContrastMemory.df <- emmeans(modelMemory, ~ old * category, type = 'response', lmer.df = 'satterthwaite') %>% 
  contrast(interaction = c("pairwise", old_superordinate, by = NULL)) %>% as.data.frame() %>%
  mutate(odds_ratio = round(exp(estimate),2),
         estimate = round(estimate, 2),
         SE = round(SE, 2),
         z.ratio = round(z.ratio, 2),
         p.value = round(p.value, 3)) 
write.csv(supContrastMemory.df, file = 'figures/paper/table_supContrastMemory.csv', row.names = F)
```


# Memory model comparisons
```{r}
em_null_memory <- glmer(correct ~ 1 + (1 | subID) + (1|vigfile),
                 data=emo_df, family=binomial(link = 'logit'), control=glmerControl(optCtrl=list(maxfun=50000)))

em_modelMemory <- glmer(correct ~ category + (1|subID) + (1|vigfile),
                     data=emo_df, family = binomial(link = 'logit'), control=glmerControl(optCtrl = list(maxfun=5000),
                                                                                              optimizer = 'bobyqa'))

em_only_memory <- glmer(correct ~ angry + sad + disgusted + afraid + contemptuous + amused +
                       (1|subID) + (1|vigfile),
                       data=emo_df, family = binomial(link = 'logit'), control=glmerControl(optCtrl = list(maxfun=5000),
                                                                                                optimizer = 'bobyqa'))

em_add_memory <- glmer(correct ~ category + angry + sad + disgusted + afraid + contemptuous + amused +
                       (1|subID) + (1|vigfile),
                       data=emo_df, family = binomial(link = 'logit'), control=glmerControl(optCtrl = list(maxfun=5000),
                                                                                                optimizer = 'bobyqa'))

em_int_memory <- glmer(correct ~ category * angry + 
                                 category * amused + 
                                 category * sad + 
                                 category * afraid + 
                                 category * contemptuous + 
                                 category * disgusted + 
                                 (1 | subID) + (1|vigfile),
                 data=emo_df, family=binomial(link = 'logit'), control=glmerControl(optCtrl=list(maxfun=1e9),
                                                                                        optimizer = 'bobyqa'))

emCompMemory.df <- compare_performance(em_null_memory, em_modelMemory, em_only_memory, em_add_memory, em_int_memory, 
                    bayesfactor = FALSE, rank = TRUE, metrics = c('AIC', 'BIC', 'R2', 'ICC', 'RMSE')) %>% 
  as.data.frame() %>% 
  mutate(AIC = round(AIC, 2),
         BIC = round(BIC, 2),
         R2_conditional = round(R2_conditional, 2),
         R2_marginal = round(R2_marginal, 2),
         ICC = round(ICC, 2),
         RMSE = round(RMSE, 2)) %>%
  select(-Type)
write.csv(emCompMemory.df, file = 'figures/paper/table_emCompMemory.csv', row.names = FALSE)

# get npar
anova(em_null_memory, em_modelMemory, em_only_memory, em_add_memory, em_int_memory)

# see printout of winner
summary(em_only_memory)

# get effect sizes as odds ratios
exp(fixef(em_only_memory))

# plot results
## first transform intercept to probability
logit2prob <- function(logit) {
  odds <- exp(logit)
  prob <- odds / (1 + odds)
  return(prob)
}

plot_mem_emo <- function(emotion, title) {
  as.data.frame(emmeans(em_only_memory, as.formula(paste0('~', emotion)), cov.reduce=range, type='response')) %>%
  ggplot(., aes_string(x=emotion, y='prob', ymin='asymp.LCL', ymax='asymp.UCL')) +
    ylim(0.75,1) + 
    geom_hline(yintercept=logit2prob(1.81), linetype='dashed', size=0.25) + 
    geom_line(size=1.25) +
    geom_ribbon(alpha=0.2) +
    labs(y='Estimated probability of hits', x=paste(title, 'Score (scaled)'), title = title) +
    theme_pubr() + 
    theme(text = element_text(family = 'Times New Roman'),
          plot.title = element_text(hjust = 0.5, size=16, face = 'bold'))
}

anger_plot <- plot_mem_emo('angry', 'Anger')
sadness_plot <- plot_mem_emo('sad', 'Sadness')
disgust_plot <- plot_mem_emo('disgusted', 'Disgust')
fear_plot <- plot_mem_emo('afraid', 'Fear')
contempt_plot <- plot_mem_emo('contemptuous', 'Contempt')
amusement_plot <- plot_mem_emo('amused', 'Amusement')

anger_plot + sadness_plot + disgust_plot + fear_plot + contempt_plot + amusement_plot +
  plot_layout(ncol = 3, nrow = 2) 
ggsave('figures/paper/plot_emMemory.png', width = 10)
```


# memory confidence model & plot
```{r, fig.width=8, fig.height=4, include=FALSE}

data$correct <- factor(data$correct, levels = c('1','0'), labels = c('Correct' ,'Incorrect'))
# run model
modelConfidence <- lmer(confresp ~ category * old * correct + (1 | subID) + (1|vigfile),
                        data=data,
                        control=lmerControl(optCtrl = list(maxeval=5000)),
                        contrasts = list(category=contr.sum))
tab_model(modelConfidence, 
          #file = 'figures/paper/table_modelConfidence.html',  
          digits = 2, 
          show.ci = 0.95, show.stat = TRUE, show.p = TRUE, show.ngroups = TRUE, show.df = TRUE,
          p.val = 'satterthwaite', 
          strings = c(stat = 't value', ci = 'CI (95%)', pred = 'Factors', p = 'p value'),
          dv.labels = 'confidence', 
          col.order = c('est','ci','df.error','stat','p'),
          pred.labels = c('Intercept', 
                          'Social Norms', 'Authority', 'Loyalty', 'Purity', 'Harm-Emo', 'Harm-Phys', 'Fairness',
                          'New', 'Incorrect',
                          'Social Norms*New', 'Authority*New', 'Loyalty*New', 'Purity*New', 'Harm-Emo*New', 'Harm-Phys*New','Fairness*New',
                          'Social Norms*Incorrect', 'Authority*Incorrect', 'Loyalty*Incorrect', 'Purity*Incorrect', 
                          'Harm-Emo*Incorrect', 'Harm-Phys*Incorrect','Fairness*Incorrect',
                          'New*Incorrect',
                          'Social Norms*New*Incorrect', 'Authority*New*Incorrect', 'Loyalty*New*Incorrect', 'Purity*New*Incorrect', 
                          'Harm-Emo*New*Incorrect', 'Harm-Phys*New*Incorrect','Fairness*New*Incorrect'))


modelConfidence_df <- emmeans(modelConfidence, ~ category*old*correct, type = 'response') %>% 
  as.data.frame()

ggplot(modelConfidence_df, aes(x=category, y=emmean)) +
  facet_wrap(. ~ correct) +
  geom_pointrange(aes(ymax=upper.CL, ymin=lower.CL, shape=old, color=category), size = 0.85, position=position_dodge(0.5)) + 
  scale_shape_manual(values = c(16,1), labels = c('Old', 'New')) +
  ylim(0,4) +
  scale_x_discrete(labels =c('S.N.', 'Auth.', 'Loy.', 'Pur.', 'Harm-E.', 'Harm-P.', 'Fair.', 'Lib.')) +
  MFT_color() + MFT_fill() + 
  theme_pubr(legend = 'top',
             base_family = 'Times New Roman',
             base_size = 19) +
  guides(color=FALSE, shape=guide_legend(title=NULL)) +
  theme(strip.text.x = element_text(size=24, face='bold'), 
        strip.background = element_rect(color = 'white'),
        axis.title.x = element_blank(),
        legend.position = c(0.05, 0.89),
        legend.text = element_text(size = 22)) +
  labs(y = 'Estimated mean confidence', color = 'Foundation')
ggsave('figures/paper/plot_modelConfidence.png', width = 15, dpi = 'retina')


ggplot(modelConfidence_df, aes(x=category, y=emmean, color=supDiffScore, group=interaction(old,supDiffScore))) +
  facet_grid(.~correct) + 
  ylim(-0.5, 4) +
  labs(y = 'Estimated mean confidence', color = 'Relative Individualizing Values', shape = 'Old/New') +
  geom_line(aes(linetype=interaction(old,supDiffScore)), position = position_dodge(0), alpha=0.4, show.legend = F) +
  scale_linetype_manual(values=c("solid", "dashed", 'solid', 'dashed')) +
  geom_pointrange(aes(ymax=lower.CL, ymin=upper.CL, shape=old),fatten=8, position = position_dodge(0)) +
  scale_shape_manual(values = c(15,21), labels = c('Old', 'New')) +
  scale_color_manual(values=c('#c40233', '#2b8cd6')) +
  +
  theme_pubr(legend = 'top') +
  theme(axis.title.x = element_blank(),
        axis.text = element_text(size = 20),
        axis.title.y = element_text(size=18),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 14))

# superordinate contrasts
supContrastConf <- modelConfidence %>% 
  emmeans(~ old * correct * category, type = 'response') %>%
  contrast(interaction=c('pairwise', 'pairwise', old_superordinate))
supContrastConf.eff <- eff_size(supContrastConf, sigma = sd(data$confresp), edf = df.residual(modelConfidence), method = 'identity') %>% as.data.frame() %>% mutate(effect.size = round(effect.size, 2))
supContrastConf.df <- as.data.frame(supContrastConf) %>%
  mutate_at(c('estimate', 'SE', 'df', 't.ratio'), funs(round(.,2)))
supContrastConf.df$eff_size <- supContrastConf.eff$effect.size 
write.csv(supContrastConf.df, file = 'figures/paper/table_supContrastConf.csv', row.names = F)
```

# Memory confidence model comparisons
```{r}
em_null_confidence <- lmer(confresp ~ correct + (1 | subID) + (1|vigfile), 
                            data=emo_df, control=lmerControl(optCtrl = list(maxeval=5000)))

em_modelConfidence <- lmer(confresp ~ category * correct + (1 | subID) + (1|vigfile), 
                        data=emo_df, control=lmerControl(optCtrl = list(maxeval=5000)))

em_only_confidence <- lmer(confresp ~ correct + angry + sad + disgusted + afraid + contemptuous + amused +
                             (1 | subID) + (1|vigfile), 
                        data=emo_df, control=lmerControl(optCtrl = list(maxeval=5000)))

em_add_confidence <- lmer(confresp ~ category + correct +  angry + sad + disgusted + afraid + contemptuous + amused +
                        (1|subID) + (1|vigfile),
                        data=emo_df, control=lmerControl(optCtrl = list(maxeval=5000)))

em_int_confidence1 <- lmer(confresp ~ correct +
                                 category * angry + 
                                 category * amused + 
                                 category * sad + 
                                 category * afraid + 
                                 category * contemptuous + 
                                 category * disgusted + 
                                 (1 | subID) + (1|vigfile),
                 data=emo_df, control=lmerControl(optCtrl=list(maxfun=5000)))

em_int_confidence2 <- lmer(confresp ~ 
                                 correct * category * angry + 
                                 correct * category * amused + 
                                 correct * category * sad + 
                                 correct * category * afraid + 
                                 correct * category * contemptuous + 
                                 correct * category * disgusted + 
                                 (1 | subID) + (1|vigfile),
                 data=emo_df, control=lmerControl(optCtrl=list(maxfun=5000)))

emCompConf.df <- compare_performance(em_null_confidence, em_modelConfidence, em_only_confidence, em_add_confidence, em_int_confidence1, em_int_confidence2, bayesfactor = FALSE, rank = TRUE) %>% 
  as.data.frame() %>%
  mutate(AIC = round(AIC, 2),
         BIC = round(BIC,2),
         R2_marginal = round(R2_marginal, 2),
         R2_conditional = round(R2_conditional, 2),
         ICC = round(ICC, 2),
         RMSE = round(RMSE, 2)) %>%
  select(-Type)
write.csv(emCompConf.df, file = 'figures/paper/table_emCompConf.csv', row.names = F)

# use anova to get npar
anova(em_null_confidence, em_modelConfidence, em_only_confidence, em_add_confidence, em_int_confidence1, em_int_confidence2)
```

# Manuscript things
```{r Tidy questionnaires, include=FALSE}
# load qualtrics
foundation_matching <- read.csv('data/behavior/qualtrics/foundation_matching.csv', stringsAsFactors = FALSE)
all_other_surveys <- read.csv('data/behavior/qualtrics/all_other_surveys.csv', stringsAsFactors = FALSE)

# score MFQ
mfq <- select(all_other_surveys, starts_with('sub'), starts_with('mfq'))
#part one
mfq[mfq == 'Not at all relevant' ] <- 0
mfq[mfq == 'Not very relevant' ] <- 1
mfq[mfq == 'Slightly relevant' ] <- 2
mfq[mfq == 'Somewhat relevant' ] <- 3
mfq[mfq == 'Very relevant' ] <- 4
mfq[mfq == 'Extremely relevant' ] <- 5
#part two
mfq[mfq == 'Strongly disagree' ] <- 0
mfq[mfq == 'Moderately disagree' ] <- 1
mfq[mfq == 'Slightly disagree' ] <- 2
mfq[mfq == 'Slightly agree' ] <- 3
mfq[mfq == 'Moderately agree' ] <- 4
mfq[mfq == 'Strongly agree' ] <- 5
# compute results
colnames(mfq) <- substr(colnames(mfq), 5, 7)
names(mfq)[1] <- 'subID'
mfq <- mfq[-1,]
mfq[,2:33] <- as.numeric(unlist(mfq[,2:33]))
mfq <- mfq %>% mutate(careScore = rowSums(select(., c('1','7','12','17','23','28')), na.rm = TRUE),
                     fairnessScore = rowSums(select(., c('2','8','13','18','24','29')), na.rm = TRUE),
                     loyaltyScore = rowSums(select(., c('3','9','14','19','25','30')), na.rm = TRUE),
                     authorityScore = rowSums(select(., c('4','10','15','20','26','31')), na.rm = TRUE),
                     purityScore = rowSums(select(., c('5','11','16','21','27','32')), na.rm = TRUE),
                     subID = as.numeric(subID)) %>%
  filter(subID != 20, subID %in% dataSubs)
mfq_data <- mfq %>% select(subID, careScore, fairnessScore, loyaltyScore, authorityScore, purityScore) %>%
  mutate(subID = as.character(subID))
data <- left_join(data, mfq_data, by='subID')

# write table 
qualtrics_means <- mfq %>% select(contains('Score')) %>%
  summarise(careMean = mean(careScore),
            careSD = sd(careScore),
            fairnessMean = mean(fairnessScore),
            fairnessSD = sd(fairnessScore),
            loyaltyMean = mean(loyaltyScore),
            loyaltySD = sd(loyaltyScore),
            authorityMean = mean(authorityScore),
            authoritySD = sd(authorityScore),
            purityMean = mean(purityScore),
            puritySD = sd(purityScore))

# score disgust_scale
disgust_scale <- select(all_other_surveys, starts_with('sub'), starts_with('disgust'))
#part one
disgust_scale[disgust_scale == 'Strongly disagree' ] <- 0
disgust_scale[disgust_scale == 'Mildly disagree' ] <- 1
disgust_scale[disgust_scale == 'Neither agree nor disagree' ] <- 2
disgust_scale[disgust_scale == 'Mildly agree' ] <- 3
disgust_scale[disgust_scale == 'Strongly agree' ] <- 4
#part two
disgust_scale[disgust_scale == 'Not disgusting at all' ] <- 0
disgust_scale[disgust_scale == 'Slightly disgusting' ] <- 1
disgust_scale[disgust_scale == 'Moderately disgusting' ] <- 2
disgust_scale[disgust_scale == 'Very disgusting' ] <- 3
disgust_scale[disgust_scale == 'Extremely disgusting' ] <- 4
# compute results
colnames(disgust_scale) <- as.character(c('subID', 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27))
disgust_scores <- select(disgust_scale, -'12', -'16') #get rid of catch questions
disgust_scores <- as.data.frame(disgust_scores[-1,])  %>%
  mutate(subID = as.numeric(subID)) %>%
  filter(subID != 20, subID %in% dataSubs)
disgust_scores[,2:25] <- as.numeric(unlist(disgust_scores[,2:25]))
reverse4 <- function(x) 4 - x
disgust_scores[,c('1','6','10')] <- reverse4(disgust_scores[,c('1','6','10')])
disgust_scores$score <- rowSums(disgust_scores[2:25])
disgust_mean <- disgust_scores %>% 
  summarise(disgustMean = mean(score),
            disgustSD = sd(score))
qualtrics_means <- cbind(qualtrics_means, disgust_mean)

# score secs - conservatism increases with score
secs <- select(all_other_surveys, starts_with('sub'), starts_with('secs'))
colnames(secs) <- substr(colnames(secs), 6, 8)
colnames(secs) <- paste0('var', colnames(secs))
names(secs)[1] <- 'subID'
secs <- secs[-1,]
secs[,2:13] <- as.numeric(unlist(secs[,2:13]))
social <- c('var1','var3','var4','var7','var8','var11','var12')
economic <- c('var2', 'var5', 'var6', 'var9', 'var10')
reverse100 <- function(x) 100 - x
reverseScoredSECS <- c('var1', 'var5')
secs[,reverseScoredSECS] <- reverse100(secs[,reverseScoredSECS])
secs <- secs %>% 
  mutate(SocialConservatism = rowMeans(select(., social), na.rm = TRUE),
         EconomicConservatism = rowMeans(select(., economic), na.rm = TRUE),
         MeanConservatism = rowMeans(select(., var1:var12), na.rm = TRUE),
         subID = as.numeric(subID)) %>%
  filter(subID != 20, subID %in% dataSubs)

secs_means <- secs %>%
  summarise(socialConservatismMean = mean(SocialConservatism),
            socialConservatismSD = sd(SocialConservatism),
            economicConservatismMean = mean(EconomicConservatism),
            economicConservatismSD = sd(EconomicConservatism))

qualtrics_means <- cbind(qualtrics_means, secs_means)
qualtrics_means <- pivot_longer(qualtrics_means, cols = 1:ncol(qualtrics_means), names_to = 'Measure', values_to = 'Value') %>%
  mutate(Value = round(Value, 2))
write.csv(qualtrics_means, file = 'figures/paper/table_qualtricsMeans.csv', row.names = F)

### prep for emotion & empathy comparison
# Emotion responses
emotion_rating <- read.csv('data/behavior/qualtrics/emotion_ratings.csv', stringsAsFactors = FALSE)
emotion_rating[2:30, 2:721] <- as.data.frame(sapply(emotion_rating[2:30, 2:721], function(s) substr(s, 1, 2)), stringsAsFactors = FALSE)
names(emotion_rating)[1] <- 'subID'
emotion_rating <- emotion_rating[2:nrow(emotion_rating),] %>% pivot_longer(2:ncol(emotion_rating), names_to=c('vigfile', 'emotion'), names_pattern='([a-z]+\\d+)\\.*(.*)' , values_to='emoresp')
emotion_rating$emotion[emotion_rating$emotion == ''] = 'angry'
emotion_rating$emotion[emotion_rating$emotion == '1'] = 'sad'
emotion_rating$emotion[emotion_rating$emotion == '2'] = 'disgusted'
emotion_rating$emotion[emotion_rating$emotion == '3'] = 'afraid'
emotion_rating$emotion[emotion_rating$emotion == '4'] = 'contemptuous'
emotion_rating$emotion[emotion_rating$emotion == '5'] = 'amused'
emotion_rating$emoresp <- as.numeric(emotion_rating$emoresp)
emotion_rating <- subset(emotion_rating, subID != c('20', '35', '36'))
# emotion_rating_pls <- pivot_wider(emotion_rating, names_from = emotion, values_from = emoresp)

assignCategory <- function(c) {
  return(ifelse(substr(c, 1,4) == 'auth', 'Authority', 
         ifelse(substr(c, 1,7) == 'careemo', 'Harm-Emo', 
         ifelse(substr(c, 1,8) == 'carephys', 'Harm-Phys', 
         ifelse(substr(c, 1,4) == 'fair', 'Fairness', 
         ifelse(substr(c, 1,3) == 'lib', 'Liberty', 
         ifelse(substr(c, 1,3) == 'loy', 'Loyalty',
         ifelse(substr(c, 1,3) == 'pur' , 'Purity', 
         ifelse(substr(c, 1,7) == 'socnorm', 'Social Norms', NA)))))))))
}

emotion_rating$category <- assignCategory(emotion_rating$vigfile)
emotion_rating$category <- factor(emotion_rating$category, levels = plotting_categories)

# load & prep empathy dataframe
all_other_surveys <- read.csv('data/behavior/qualtrics/all_other_surveys.csv', stringsAsFactors = FALSE)
iri <- select(all_other_surveys, starts_with('sub'), starts_with('iri'))
# score iri
iri <- as.data.frame(sapply(iri, function(s) substr(s, 1, 2)), stringsAsFactors = FALSE)
colnames(iri) <- substr(colnames(iri), 5, 7)
iri <- as.data.frame(sapply(iri, function(x) gsub("^\t* *\"* *| *\"* *\t*$", "", x)), stringsAsFactors = FALSE)
names(iri)[1] <- 'subID'
iri <- iri[-1,]
iri[iri == 'A' ] <- 0
iri[iri == 'B' ] <- 1
iri[iri == 'C' ] <- 2
iri[iri == 'D' ] <- 3
iri[iri == 'E' ] <- 4
iri[,2:29] <- as.numeric(unlist(iri[,2:29]))
reverseScoredIRI <- c('3', '4', '7', '12', '13', '14', '15', '18', '19')
iri[,reverseScoredIRI] <- 4 - (iri[,reverseScoredIRI])
#subscale coding
perspective_taking <- c('3','8','11','15','21','25','28')
fantasy <- c('1', '5', '7','12','16','23','26')
empathic_concern <- c('2','4','9','14','18','20','22')
personal_distress <- c('6','10','13','17', '19', '24','27')
#compute scores
iri <- iri %>% mutate(PerspectiveTakingScore = rowSums(select(., perspective_taking), na.rm = TRUE),
                     FantasyScore = rowSums(select(., fantasy), na.rm = TRUE),
                     EmpathicConcernScore = rowSums(select(., empathic_concern), na.rm = TRUE),
                     PersonalDistressScore = rowSums(select(., personal_distress), na.rm = TRUE))
iri <- filter(iri, subID %in% dataSubs, subID != 20)

# make dataframes for comparison
emotion_rating_compare <- pivot_wider(emotion_rating, names_from = emotion, values_from = emoresp)
em_compare <- left_join(data_old, emotion_rating_compare, by = c('subID', 'vigfile', 'category'))
empathy_scores <- select(iri, PersonalDistressScore, EmpathicConcernScore, PerspectiveTakingScore, FantasyScore, subID)
em_compare <- left_join(em_compare, empathy_scores, by='subID') %>%
  drop_na(c(angry, sad, disgusted, afraid, contemptuous, amused, PersonalDistressScore, EmpathicConcernScore, PerspectiveTakingScore, FantasyScore))

# write tables with means 
# em_compare_means <- em_compare %>% group_by(category) %>% 
#   summarise(moral_judgment_mean = round(mean(moral_decision, na.rm = T), 3),
#             moral_judgment_SD = round(sd(moral_decision, na.rm = T), 3),
#             memory_accuracy_mean = round(mean(correct), 3),
#             memory_accuracy_SD = round(sd(correct), 3),
#             memory_confidence_mean = round(mean(confresp), 3),
#             memory_confidence_SD = round(sd(confresp), 3),
#             anger_mean = round(mean(angry, na.rm=T), 3),
#             anger_SD = round(sd(angry, na.rm = T), 3),
#             amusement_mean = round(mean(amused, na.rm=T), 3),
#             amusement_SD = round(sd(amused, na.rm=T), 3),
#             sadness_mean = round(mean(sad, na.rm=T), 3),
#             sadness_SD = round(sd(sad, na.rm=T), 3),
#             fear_mean = round(mean(afraid, na.rm=T), 3),
#             fear_SD = round(sd(afraid, na.rm=T), 3),
#             contempt_mean = round(mean(contemptuous, na.rm=T), 3),
#             contempt_SD = round(sd(contemptuous, na.rm = T), 3),
#             disgust_mean = round(mean(disgusted, na.rm=T), 3),
#             disgust_SD = round(sd(disgusted, na.rm=T),3),
#             personal_distress_mean = round(mean(PersonalDistressScore, na.rm=TRUE), 3),
#             personal_distress_SD = round(sd(PersonalDistressScore, na.rm=TRUE), 3),
#             empathic_concern_mean = round(mean(EmpathicConcernScore, na.rm=TRUE), 3),
#             empathic_concern_SD = round(sd(EmpathicConcernScore, na.rm=TRUE), 3),
#             perspective_taking_mean = round(mean(PerspectiveTakingScore, na.rm=TRUE), 3),
#             perspective_taking_SD = round(sd(PerspectiveTakingScore, na.rm=TRUE), 3),
#             fantasy_mean = round(mean(FantasyScore, na.rm=T), 3),
#             fantasy_SD = round(sd(FantasyScore, na.rm=T), 3))
# write.csv(em_compare_means, file = 'figures/paper/table_em_compareMeans.csv', row.names = F)

# scale em values for model fitting
em_compare <- em_compare %>% 
  mutate(angry = scale(angry),
         sad = scale(sad),
         disgusted = scale(disgusted),
         afraid = scale(afraid),
         contemptuous = scale(contemptuous),
         amused = scale(amused),
         PersonalDistressScore = scale(PersonalDistressScore),
         EmpathicConcernScore = scale(EmpathicConcernScore),
         PerspectiveTakingScore = scale(PerspectiveTakingScore),
         FantasyScore = scale(FantasyScore)) %>%
  filter(subID != '20')

# visualize variable correlations
# emotion_scores <- na.omit(em_compare[,20:27])
# corr <- cor(emotion_scores)
# ggcorrplot(corr, lab = TRUE)
# ggsave('emo_corr_matrix.png')
```

```{r summary tables and such}
# participant demographics -- this data is not available in the repo
# full_demographics <- read.csv('data/ppt_log.csv', stringsAsFactors = FALSE)
# sex_distribution <- full_demographics %>% 
#   filter(MFT_id %in% dataSubs) %>% 
#   count(Sex)
# age_stats <- full_demographics %>% 
#   filter(MFT_id %in% dataSubs) %>% 
#   mutate(Birthdate = as.Date(Birthdate), #as.Date is from eeptools, which is not compatible with R version 4.0.0
#          Scan.date = as.Date(Scan.date),
#          age = age_calc(Birthdate, Scan.date, units = 'years')) %>%
#   summarise(meanAge = mean(age), SD = sd(age))

# write table with means for supplement
data_means <- data %>% group_by(category, old) %>% summarise(moral_judgment_mean = round(mean(moral_decision, na.rm = T), 3),
                                                                 moral_judgment_SD = round(sd(moral_decision, na.rm = T), 3),
                                                                 memory_accuracy_mean = round(mean(correct), 3),
                                                                 memory_accuracy_SD = round(sd(correct), 3),
                                                                 memory_confidence_mean = round(mean(confresp), 3),
                                                                 memory_confidence_SD = round(sd(confresp), 3))
write.csv(data_means, file = 'figures/paper/table_dataMeans.csv', row.names = F)

# write tables with means 
# emo_df_means <- emo_df %>% group_by(category) %>% 
#   summarise(moral_judgment_mean = round(mean(moral_decision, na.rm = T), 3),
#             moral_judgment_SD = round(sd(moral_decision, na.rm = T), 3),
#             memory_accuracy_mean = round(mean(correct), 3),
#             memory_accuracy_SD = round(sd(correct), 3),
#             memory_confidence_mean = round(mean(confresp), 3),
#             memory_confidence_SD = round(sd(confresp), 3),
#             anger_mean = round(mean(angry, na.rm=T), 3),
#             anger_SD = round(sd(angry, na.rm = T), 3),
#             amusement_mean = round(mean(amused, na.rm=T), 3),
#             amusement_SD = round(sd(amused, na.rm=T), 3),
#             sadness_mean = round(mean(sad, na.rm=T), 3),
#             sadness_SD = round(sd(sad, na.rm=T), 3),
#             fear_mean = round(mean(afraid, na.rm=T), 3),
#             fear_SD = round(sd(afraid, na.rm=T), 3),
#             contempt_mean = round(mean(contemptuous, na.rm=T), 3),
#             contempt_SD = round(sd(contemptuous, na.rm = T), 3),
#             disgust_mean = round(mean(disgusted, na.rm=T), 3),
#             disgust_SD = round(sd(disgusted, na.rm=T),3),
# write.csv(em_compare_means, file = 'figures/paper/table_em_compareMeans.csv', row.names = F)
```



# multiple voxel extraction
```{r}
# assignSupLV1 <- function(c) {
#   return(ifelse(c == 'Authority', 0,
#          ifelse(c == 'Harm-Emo', 1,
#          ifelse(c == 'Harm-Phys', 1,
#          ifelse(c == 'Purity', 1,
#          ifelse(c == 'Fairness', 0,
#          ifelse(c == 'Loyalty', 0,
#          ifelse(c == 'Liberty', 0,
#          ifelse(c == 'Social Norms', 0, NA)))))))))
# }
# # amygdala
# amyg_activity1 <- read.delim(file = '../MFT_PLS/4_TR_analysis/multiple voxel extraction/amygdala/amygdala1_fMRIvoxeldata.txt', header = FALSE, sep = "")
# colnames(amyg_activity1) <- c('TR1','TR2','TR3','TR4')
# amyg_activity1$category <- rep(matlab_categories, each=27)
# amyg_activity1$subID <- dataSubs
# amyg_activity1 <- pivot_longer(amyg_activity1, cols = c(TR1, TR2, TR3, TR4), names_to = 'TR', values_to = 'Intensity')
# amyg_activity1$category <- factor(amyg_activity1$category, levels = plotting_categories)
# amyg_activity1_means <- amyg_activity1 %>% group_by(category, TR) %>%
#   summarise(Intensity = mean(Intensity))
# amyg_activity1_means$alpha <- assignSupLV1(amyg_activity1_means$category)
# 
# amy1 <- ggplot(amyg_activity1_means, aes(x=TR, y=Intensity, color=category, group = category, alpha = alpha == 0)) +
#   scale_x_discrete(expand = c(0, 0, 0, 0.08)) +
#   geom_hline(aes(yintercept = 0), size=1) +
#   geom_line(size=1) + 
#   geom_point(aes(fill=category, color=category, shape = category), size=3) +
#   scale_shape_manual(values = c(4,15,16,17,0,1,2, 3)) +
#   scale_alpha_manual(values = c(1, 0.3), guide = FALSE) +
#   MFT_color() + 
#   theme_pubr(legend = 'right') +
#   theme(plot.title = element_text(hjust = 0.5)) +
#   ggtitle('(-32, -4, -20)')
# 
# amyg_activity2 <- read.delim(file = '../MFT_PLS/4_TR_analysis/multiple voxel extraction/amygdala/amygdala2_fMRIvoxeldata.txt', header = FALSE, sep = "")
# colnames(amyg_activity2) <- c('TR1','TR2','TR3','TR4')
# amyg_activity2$category <- rep(matlab_categories, each=27)
# amyg_activity2$subID <- dataSubs
# amyg_activity2 <- pivot_longer(amyg_activity2, cols = c(TR1, TR2, TR3, TR4), names_to = 'TR', values_to = 'Intensity')
# amyg_activity2$category <- factor(amyg_activity2$category, levels = plotting_categories)
# amyg_activity2_means <- amyg_activity2 %>% group_by(category, TR) %>%
#   summarise(Intensity = mean(Intensity))
# amyg_activity2_means$alpha <- assignSupLV1(amyg_activity2_means$category)
# 
# amy2 <- ggplot(amyg_activity2_means, aes(x=TR, y=Intensity, color=category, group = category, alpha = alpha == 0)) +
#   scale_x_discrete(expand = c(0, 0, 0, 0.08)) +
#   geom_hline(aes(yintercept = 0), size=1) +
#   geom_line(size=1) + 
#   geom_point(aes(fill=category, color=category, shape = category), size=3) +
#   scale_shape_manual(values = c(4,15,16,17,0,1,2, 3)) +
#   scale_alpha_manual(values = c(1, 0.3), guide = FALSE) +
#   MFT_color() + 
#   theme_pubr(legend = 'right') +
#   theme(plot.title = element_text(hjust = 0.5)) +
#   ggtitle('(-18, -8, -14)')
# 
# amyg_activity3 <- read.delim(file = '../MFT_PLS/4_TR_analysis/multiple voxel extraction/amygdala/amygdala3_fMRIvoxeldata.txt', header = FALSE, sep = "")
# colnames(amyg_activity3) <- c('TR1','TR2','TR3','TR4')
# amyg_activity3$category <- rep(matlab_categories, each=27)
# amyg_activity3$subID <- dataSubs
# amyg_activity3 <- pivot_longer(amyg_activity3, cols = c(TR1, TR2, TR3, TR4), names_to = 'TR', values_to = 'Intensity')
# amyg_activity3$category <- factor(amyg_activity3$category, levels = plotting_categories)
# amyg_activity3_means <- amyg_activity3 %>% group_by(category, TR) %>%
#   summarise(Intensity = mean(Intensity))
# amyg_activity3_means$alpha <- assignSupLV1(amyg_activity3_means$category)
# 
# 
# amy3 <- ggplot(amyg_activity3_means, aes(x=TR, y=Intensity, color=category, group = category, alpha = alpha == 0)) +
#   scale_x_discrete(expand = c(0, 0, 0, 0.08)) +
#   geom_hline(aes(yintercept = 0), size=1) +
#   geom_line(size=1) + 
#   geom_point(aes(fill=category, color=category, shape = category), size=3) +
#   scale_shape_manual(values = c(4,15,16,17,0,1,2, 3)) +
#   scale_alpha_manual(values = c(1, 0.3), guide = FALSE) +
#   MFT_color() + 
#   theme_pubr(legend = 'right') +
#   theme(plot.title = element_text(hjust = 0.5)) +
#   ggtitle('(20, -8, -16)')
# 
# amy1 + amy2 + amy3 + plot_layout(guides = 'collect') 
# 
# 
# insula_activity <- read.delim(file = '../MFT_PLS/4_TR_analysis/multiple voxel extraction/insula/insula_fMRIvoxeldata.txt', header = FALSE, sep = "")
# colnames(insula_activity) <- c('TR1','TR2','TR3','TR4')
# insula_activity$category <- rep(matlab_categories, each=27)
# insula_activity$subID <- dataSubs
# insula_activity <- pivot_longer(insula_activity, cols = c(TR1, TR2, TR3, TR4), names_to = 'TR', values_to = 'Intensity')
# insula_activity$category <- factor(insula_activity$category, levels = plotting_categories)
# insula_activity_means <- insula_activity %>% group_by(category, TR) %>%
#   summarise(Intensity = mean(Intensity))
# 
# ggplot(insula_activity_means, aes(x=TR, y=Intensity, color=category, group = category)) +
#   scale_x_discrete(expand = c(0, 0, 0, 0.08)) +
#   geom_hline(aes(yintercept = 0), size=1) +
#   geom_line(size=1) + 
#   geom_point(aes(fill=category, color=category, shape = category), size=3) +
#   scale_shape_manual(values = c(4,15,16,17,0,1,2, 3)) +
#   MFT_color() + 
#   theme_pubr() +
#   ggtitle('Insula voxel response')

```

# Behavioral PLS
```{r behavioral PLS}
# create txt file for analysis -- participants nested in condition, conservatism score assigned to each participant
# let's do 1 analysis where we split up conservatism btwn social and economic, and another where we use the mean conservatism score
two_cond <- cbind.data.frame(rep(matlab_categories, each=26), rep(secs$subID, 8), 
                             rep(secs$EconomicConservatism, 8), rep(secs$SocialConservatism, 8))
names <- c('foundation', 'subID', 'EconomicConservatism', 'SocialConservatism')
colnames(two_cond) <- names
two_cond %>% select(EconomicConservatism, SocialConservatism) %>%
  write.table(., 'data/two_cond_behav.txt', row.names = F, col.names = F, sep=' ')

mean_cond <- cbind.data.frame(rep(matlab_categories, each=26), rep(secs$subID, 8), rep(secs$MeanConservatism, 8))
names <- c('foundation', 'subID', 'Conservatism')
colnames(mean_cond) <- names
mean_cond %>% 
  filter(foundation %in% c('Authority', 'Loyalty', 'Purity', 'Harm-Emo', 'Harm-Phys', 'Fairness')) %>%
  select(Conservatism) %>%
  write.table(., 'data/mean_cond_behav.txt', row.names = F, col.names=F, sep=' ')

mean_cond %>% 
  filter(foundation %in% c('Loyalty', 'Purity', 'Harm-Emo', 'Harm-Phys', 'Fairness')) %>%
  select(Conservatism) %>%
  write.table(., 'data/NR_sup_dropAuth.txt', row.names = F, col.names=F, sep=' ')
```

# code for plotting complex models from over the summer
```{r em_int_moral summary stuff}

# compute effect size
# emmeans(em_add_moral, ~ category) %>% 
#   eff_size(sigma=sd(em_compare$moral_decision), edf=df.residual(em_add_moral), method='eff')
# 
# em_add.cov <- list(angry=0, amused=0, sad=0, afraid=0, contemptuous=0, disgusted=0)
# 
# em_add_effsize <- function(model, dv, em_measure) {
#    arglist <- list(em_add.cov, c(0,1))
#    names(arglist) <- c('.x', em_measure)
#    return(emmeans(model, as.formula(paste0('~', em_measure)),
#                   at=do.call(list_modify, arglist)) %>%
#      eff_size(sigma=sd(em_compare[,c(dv)]), edf=df.residual(model), method='revpairwise'))
# }
# 
# em_add_effsize(em_add_moral, 'moral_decision', 'angry')
# em_add_effsize(em_add_moral, 'moral_decision', 'sad')
# em_add_effsize(em_add_moral, 'moral_decision', 'disgusted')
# em_add_effsize(em_add_moral, 'moral_decision', 'afraid')
# em_add_effsize(em_add_moral, 'moral_decision', 'contemptuous')
# em_add_effsize(em_add_moral, 'moral_decision', 'amused')

# compute effect sizes
# em_category.cov <- list(angry=0, amused=0, sad=0, afraid=0, contemptuous=0, disgusted=0, 
#                         PersonalDistressScore=0, EmpathicConcernScore=0, 
#                         PerspectiveTakingScore=0, FantasyScore=0)
# 
# emmeans(em_category, ~ category, at=em_category.cov) %>%
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'eff')
# 
# emmeans(em_category, ~ angry, at=list_modify(em_category.cov, angry=c(0,1))) %>%
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'revpairwise')
# 
# emmeans(em_category, ~ amused, at=list_modify(em_category.cov, amused=c(0,1))) %>%
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'revpairwise')
# 
# em_categorySad <- emmeans(em_category, ~ sad, at=list_modify(em_category.cov, sad=c(0,1))) %>%
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'revpairwise')
# 
# emmeans(em_category, ~ afraid, at=list_modify(em_category.cov, afraid=c(0,1))) %>%
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'revpairwise')
# 
# emmeans(em_category, ~ contemptuous, at=list_modify(em_category.cov, contemptuous=c(0,1))) %>%
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'revpairwise')
# 
# emmeans(em_category, ~ disgusted, at=list_modify(em_category.cov, disgusted=c(0,1))) %>% 
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'revpairwise')
# 
# emmeans(em_category, ~ PersonalDistressScore, at=list_modify(em_category.cov, PersonalDistressScore=c(0,1))) %>%
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'revpairwise')
# 
# emmeans(em_category, ~ EmpathicConcernScore, at=list_modify(em_category.cov, EmpathicConcernScore=c(0,1))) %>%
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'revpairwise')
# 
# emmeans(em_category, ~ PerspectiveTakingScore, at=list_modify(em_category.cov, PerspectiveTakingScore=c(0,1))) %>%
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'revpairwise')
# 
# emmeans(em_category, ~ FantasyScore, at=list_modify(em_category.cov, FantasyScore=c(0,1))) %>% 
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'revpairwise')
# 
# emmeans(em_category, ~ angry * category, at=list_modify(em_category.cov, angry=c(0,1))) %>% 
#   contrast(interaction=c('revpairwise', 'eff')) %>%
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'identity')
# 
# emmeans(em_category, ~ amused * category, at=list_modify(em_category.cov, amused=c(0,1))) %>% 
#   contrast(interaction=c('revpairwise', 'eff')) %>%
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'identity')
# 
# emmeans(em_category, ~ sad * category, at=list_modify(em_category.cov, sad=c(0,1))) %>%
#   contrast(interaction=c('revpairwise', 'eff')) %>%
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'identity')
# 
# emmeans(em_category, ~ afraid * category, at=list_modify(em_category.cov, afraid=c(0,1))) %>% 
#   contrast(interaction=c('revpairwise', 'eff')) %>%
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'identity')
# 
# emmeans(em_category, ~ afraid * category, at=list_modify(em_category.cov, afraid=c(0,1))) %>% 
#   contrast(interaction=c('revpairwise', 'eff')) %>%
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'identity')
# 
# emmeans(em_category, ~ contemptuous * category, at=list_modify(em_category.cov, contemptuous=c(0,1))) %>% 
#   contrast(interaction=c('revpairwise', 'eff')) %>%
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'identity')
# 
# emmeans(em_category, ~ disgusted * category, at=list_modify(em_category.cov, disgusted=c(0,1))) %>% 
#   contrast(interaction=c('revpairwise', 'eff')) %>%
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'identity')
# 
# emmeans(em_category, ~ PersonalDistressScore * category, at=list_modify(em_category.cov, PersonalDistressScore=c(0,1))) %>% 
#   contrast(interaction=c('revpairwise', 'eff')) %>%
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'identity')
# 
# emmeans(em_category, ~ EmpathicConcernScore * category, at=list_modify(em_category.cov, EmpathicConcernScore=c(0,1))) %>% 
#   contrast(interaction=c('revpairwise', 'eff')) %>%
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'identity')
# 
# emmeans(em_category, ~ PerspectiveTakingScore * category, at=list_modify(em_category.cov, PerspectiveTakingScore=c(0,1))) %>% 
#   contrast(interaction=c('revpairwise', 'eff')) %>%
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'identity')
# 
# emmeans(em_category, ~ FantasyScore * category, at=list_modify(em_category.cov, FantasyScore=c(0,1))) %>% 
#   contrast(interaction=c('revpairwise', 'eff')) %>%
#   eff_size(sigma = sd(em_compare$moral_decision), edf = df.residual(em_category), method = 'identity')

### compute lines for plotting
# em_range <- function(emotion, precision=0.5) {
#   return(seq(min(em_compare[,emotion], na.rm=TRUE),
#              max(em_compare[,emotion], na.rm=TRUE),
#              precision))
# }
# 
# # make dfs for plotting
# anger_trends <- as.data.frame(emmeans(em_category, ~ angry | category, at=list(angry=em_range('angry'))))
# anger_effect <- as.data.frame(emmeans(em_category, ~ angry, at=list(angry=em_range('angry'))))
# anger.emt <- emtrends(em_category, ~ category, 'angry')

#### plot
# ggplot(anger_trends, aes(x=angry, y=emmean,ymin=lower.CL, ymax=upper.CL)) +
#   geom_line(data = anger_effect) +
#   geom_ribbon(data = anger_effect, alpha = 0.2) +
#   geom_line(aes(color=category)) +
#   geom_ribbon(aes(fill=category), alpha=0.3) +
#   facet_grid(. ~ category) +
#   MFT_color() + MFT_fill() +
#   theme_pubr(legend = 'none') +
#   labs(y='Moral judgment', x='Anger Score (scaled)', tag = 'A.', title = 'Anger') +
#   theme(axis.text = element_text(size=10),
#         plot.title = element_text(size = 16, hjust = 0.5, face = 'bold'),
#         strip.background = element_rect(color = 'black', fill='gray99', size = 0.25),
#         strip.text = element_text(face = 'bold', size = 12),
#         panel.border = element_rect(colour = 'black', fill = NA, size = 0.25),
#         axis.line = element_line(size = 0.25),
#         text = element_text(family = 'Times New Roman'))
# ggsave('figures/paper/plot_anger.png', dpi = 300, width = 13, height = 3.5)
# contrast(anger.emt, adjust = 'none')
# 
# ggplot(amusement_trends, aes(x=amused, y=emmean,ymin=lower.CL, ymax=upper.CL)) +
#   geom_line(data = amusement_effect) +
#   geom_ribbon(data = amusement_effect, alpha = 0.2) +
#   geom_line(aes(color=category)) +
#   geom_ribbon(aes(fill=category), alpha=0.3) +
#   facet_grid(. ~ category) +
#   MFT_color() + MFT_fill() +
#   theme_pubr(legend = 'none') +
#   labs(y='Moral judgment', x='Amusement Score (scaled)', tag = 'B.', title = 'Amusement') +
#   theme(axis.text = element_text(size=10),
#         plot.title = element_text(size = 16, hjust = 0.5, face = 'bold'),
#         strip.background = element_rect(color = 'black', fill='gray99', size = 0.25),
#         strip.text = element_text(face = 'bold', size = 12),
#         panel.border = element_rect(colour = 'black', fill = NA, size = 0.25),
#         axis.line = element_line(size = 0.25),
#         text = element_text(family = 'Times New Roman'))
# ggsave('figures/paper/plot_amusement.png', width=13, height = 3.5, dpi = 300)
# contrast(amusement.emt, adjust = 'none')
# 
# 
# ggplot(sadness_trends, aes(x=sad, y=emmean,ymin=lower.CL, ymax=upper.CL)) +
#   geom_line(data = sadness_effect) +
#   geom_ribbon(data = sadness_effect, alpha = 0.2) +
#   geom_line(aes(color=category)) +
#   geom_ribbon(aes(fill=category), alpha=0.3) +
#   facet_grid(. ~ category) +
#   MFT_color() + MFT_fill() +
#   theme_pubr(legend = 'none') +
#   labs(y='Moral judgment', x='Sadness Score (scaled)', tag = 'C.', title = 'Sadness') +
#   theme(axis.text = element_text(size=10),
#         plot.title = element_text(size = 16, hjust = 0.5, face = 'bold'),
#         strip.background = element_rect(color = 'black', fill='gray99', size = 0.25),
#         strip.text = element_text(face = 'bold', size = 12),
#         panel.border = element_rect(colour = 'black', fill = NA, size = 0.25),
#         axis.line = element_line(size = 0.25),
#         text = element_text(family = 'Times New Roman'))
# ggsave('figures/paper/plot_sadness.png', width = 13, height = 3.5, dpi = 300)
# contrast(sadness.emt, adjust = 'none')
# 
# ggplot(fear_trends, aes(x=afraid, y=emmean,ymin=lower.CL, ymax=upper.CL)) +
#   geom_line(data = fear_effect) +
#   geom_ribbon(data = fear_effect, alpha = 0.2) +
#   geom_line(aes(color=category)) +
#   geom_ribbon(aes(fill=category), alpha=0.3) +
#   facet_grid(. ~ category) +
#   MFT_color() + MFT_fill() +
#   theme_pubr(legend = 'none') +
#   labs(y='Moral judgment', x='Fear Score (scaled)', tag = 'D.', title = 'Fear') +
#   theme(axis.text = element_text(size=10),
#         plot.title = element_text(size = 16, hjust = 0.5, face = 'bold'),
#         strip.background = element_rect(color = 'black', fill='gray99', size = 0.25),
#         strip.text = element_text(face = 'bold', size = 12),
#         panel.border = element_rect(colour = 'black', fill = NA, size = 0.25),
#         axis.line = element_line(size = 0.25),
#         text = element_text(family = 'Times New Roman'))
# ggsave('figures/paper/plot_fear.png', width = 13, height = 3.5, dpi = 300)
# contrast(fear.emt, adjust = 'none')
# 
# ggplot(contempt_trends, aes(x=contemptuous, y=emmean,ymin=lower.CL, ymax=upper.CL)) +
#   geom_line(data = contempt_effect) +
#   geom_ribbon(data = contempt_effect, alpha = 0.2) +
#   geom_line(aes(color=category)) +
#   geom_ribbon(aes(fill=category), alpha=0.3) +
#   facet_grid(. ~ category) +
#   MFT_color() + MFT_fill() +
#   theme_pubr(legend = 'none') +
#   labs(y='Moral judgment', x='Contempt Score (scaled)', tag = 'E.', title = 'Contempt') +
#   theme(axis.text = element_text(size=10),
#         plot.title = element_text(size = 16, hjust = 0.5, face = 'bold'),
#         strip.background = element_rect(color = 'black', fill='gray99', size = 0.25),
#         strip.text = element_text(face = 'bold', size = 12),
#         panel.border = element_rect(colour = 'black', fill = NA, size = 0.25),
#         axis.line = element_line(size = 0.25),
#         text = element_text(family = 'Times New Roman'))
# ggsave('figures/paper/plot_contempt.png', width = 13, height = 3.5, dpi = 300)
# contrast(contempt.emt, adjust = 'none')
# 
# ggplot(disgust_trends, aes(x=disgusted, y=emmean,ymin=lower.CL, ymax=upper.CL)) +
#   geom_line(data = disgust_effect) +
#   geom_ribbon(data = disgust_effect, alpha = 0.2) +
#   geom_line(aes(color=category)) +
#   geom_ribbon(aes(fill=category), alpha=0.3) +
#   facet_grid(. ~ category) +
#   MFT_color() + MFT_fill() +
#   theme_pubr(legend = 'none') +
#   labs(y='Moral judgment', x='Disgust Score (scaled)', tag = 'F.', title = 'Disgust') +
#   theme(axis.text = element_text(size=10),
#         plot.title = element_text(size = 16, hjust = 0.5, face = 'bold'),
#         strip.background = element_rect(color = 'black', fill='gray99', size = 0.25),
#         strip.text = element_text(face = 'bold', size = 12),
#         panel.border = element_rect(colour = 'black', fill = NA, size = 0.25),
#         axis.line = element_line(size = 0.25),
#         text = element_text(family = 'Times New Roman'))
# ggsave('figures/paper/plot_disgust.png', width = 13, height = 3.5, dpi = 300)
# contrast(disgust.emt, adjust = 'none')
# 
# ggplot(personalDistress_trends, aes(x=PersonalDistressScore, y=emmean,ymin=lower.CL, ymax=upper.CL)) +
#   geom_line(data = personalDistress_effect) +
#   geom_ribbon(data = personalDistress_effect, alpha = 0.2) +
#   geom_line(aes(color=category)) +
#   geom_ribbon(aes(fill=category), alpha=0.3) +
#   facet_grid(. ~ category) +
#   MFT_color() + MFT_fill() +
#   theme_pubr(legend = 'none') +
#   labs(y='Moral judgment', x='Personal Distress Score (scaled)', tag = 'G.', title = 'Personal Distress') +
#   theme(axis.text = element_text(size=10),
#         plot.title = element_text(size = 16, hjust = 0.5, face = 'bold'),
#         strip.background = element_rect(color = 'black', fill='gray99', size = 0.25),
#         strip.text = element_text(face = 'bold', size = 12),
#         panel.border = element_rect(colour = 'black', fill = NA, size = 0.25),
#         axis.line = element_line(size = 0.25),
#         text = element_text(family = 'Times New Roman'))
# ggsave('figures/paper/plot_personalDistress.png', width = 13, height = 3.5, dpi = 300)
# contrast(PD.emt, adjust = 'none')
# 
# ggplot(empathicConcern_trends, aes(x=EmpathicConcernScore, y=emmean,ymin=lower.CL, ymax=upper.CL)) +
#   geom_line(data = empathicConcern_effect) +
#   geom_ribbon(data = empathicConcern_effect, alpha = 0.2) +
#   geom_line(aes(color=category)) +
#   geom_ribbon(aes(fill=category), alpha=0.3) +
#   facet_grid(. ~ category) +
#   MFT_color() + MFT_fill() +
#   theme_pubr(legend = 'none') +
#   labs(y='Moral judgment', x='Empathic Concern Score (scaled)', tag = 'H.', title = 'Empathic Concern') +
#   theme(axis.text = element_text(size=10),
#         plot.title = element_text(size = 16, hjust = 0.5, face = 'bold'),
#         strip.background = element_rect(color = 'black', fill='gray99', size = 0.25),
#         strip.text = element_text(face = 'bold', size = 12),
#         panel.border = element_rect(colour = 'black', fill = NA, size = 0.25),
#         axis.line = element_line(size = 0.25),
#         text = element_text(family = 'Times New Roman'))
# ggsave('figures/paper/plot_empathicConcern.png', width = 13, height = 3.5, dpi = 300)
# contrast(EC.emt, adjust = 'none')
# 
# ggplot(perspectiveTaking_trends, aes(x=PerspectiveTakingScore, y=emmean,ymin=lower.CL, ymax=upper.CL)) +
#   geom_line(data = perspectiveTaking_effect) +
#   geom_ribbon(data = perspectiveTaking_effect, alpha = 0.2) +
#   geom_line(aes(color=category)) +
#   geom_ribbon(aes(fill=category), alpha=0.3) +
#   facet_grid(. ~ category) +
#   MFT_color() + MFT_fill() +
#   theme_pubr(legend = 'none') +
#   labs(y='Moral judgment', x='Perspective Taking Score (scaled)', tag = 'I.', title = 'Perspective Taking') +
#   theme(axis.text = element_text(size=10),
#         plot.title = element_text(size = 16, hjust = 0.5, face = 'bold'),
#         strip.background = element_rect(color = 'black', fill='gray99', size = 0.25),
#         strip.text = element_text(face = 'bold', size = 12),
#         panel.border = element_rect(colour = 'black', fill = NA, size = 0.25),
#         axis.line = element_line(size = 0.25),
#         text = element_text(family = 'Times New Roman'))
# ggsave('figures/paper/plot_perspectiveTaking.png', width = 13, height = 3.5, dpi = 300)
# contrast(PT.emt, adjust = 'none')
# 
# ggplot(fantasy_trends, aes(x=FantasyScore, y=emmean,ymin=lower.CL, ymax=upper.CL)) +
#   geom_line(data = fantasy_effect) +
#   geom_ribbon(data = fantasy_effect, alpha = 0.2) +
#   geom_line(aes(color=category)) +
#   geom_ribbon(aes(fill=category), alpha=0.3) +
#   facet_grid(. ~ category) +
#   MFT_color() + MFT_fill() +
#   theme_pubr(legend = 'none') +
#   labs(y='Moral judgment', x='Fantasy Score (scaled)', tag = 'J.', title = 'Fantasy') +
#   theme(axis.text = element_text(size=10),
#         plot.title = element_text(size = 16, hjust = 0.5, face = 'bold'),
#         strip.background = element_rect(color = 'black', fill='gray99', size = 0.25),
#         strip.text = element_text(face = 'bold', size = 12),
#         panel.border = element_rect(colour = 'black', fill = NA, size = 0.25),
#         axis.line = element_line(size = 0.25),
#         text = element_text(family = 'Times New Roman'))
# ggsave('figures/paper/plot_fantasy.png', width = 13, height = 3.5, dpi = 300)
# contrast(fantasy.emt, adjust = 'none')



# secs_range <- function(conservatism, precision=0.5) {
#   return(seq(min(data[,conservatism], na.rm=TRUE),
#              max(data[,conservatism], na.rm=TRUE),
#              precision))
# }
# 
# # make dfs for plotting
# fairness_trends_soc <- as.data.frame(emmeans(modelMoral, ~ SocialConservatism | category, at=list(SocialConservatism=secs_range('SocialConservatism'), category = 'Fairness')))
# fairness_trends_soc <- fairness_trends_soc %>% rename(conservatism_value = SocialConservatism)
# fairness_trends_soc$conservatism_type <- 'social'
# 
# fairness_trends_econ <- as.data.frame(emmeans(modelMoral, ~ EconomicConservatism | category, at=list(EconomicConservatism=secs_range('EconomicConservatism'), category = 'Fairness')))
# fairness_trends_econ <- fairness_trends_econ %>% rename(conservatism_value = EconomicConservatism)
# fairness_trends_econ$conservatism_type <- 'economic'
# fairness_trends <- rbind(fairness_trends_econ, fairness_trends_soc)
# 
# ggplot(fairness_trends, aes(x=conservatism_value, y=emmean, ymin=lower.CL, ymax=upper.CL,
#                             color=conservatism_type, fill=conservatism_type)) +
#   ylim(1, 4) + 
#   geom_ribbon(alpha = 0.1, color = 'gray') +
#   geom_line() + 
#   labs(y = 'Estimated moral judgment', x = 'Conservatism (scaled)', title = 'Conservatism x Fairness') +
#   theme_pubr(legend = 'right') +
#   theme(plot.title = element_text(hjust = 0.5))
# ggsave('/Users/maria/Desktop/fairness.png', width = 8)
# 
# library(viridis)
# estimates <- emmeans(modelMoral, ~ category*SocialConservatism, at=list(SocialConservatism=c(-1,0,1))) %>% as.data.frame()
# 
# ggplot(estimates, aes(x=SocialConservatism, y=emmean, color=SocialConservatism, group = SocialConservatism)) + 
#   geom_point(size = 3) + 
#   geom_line() + 
#   scale_color_continuous(high = "#132B43", low = "#56B1F7") +
#   theme_classic() + 
#   facet_grid(~ category)
# ggsave('/Users/maria/Desktop/conservatism.png', width = 15)
# 
# # plot
# modelMoral_df <- as.data.frame(emmeans(modelMoral, ~ category*SocialConservatism*EconomicConservatism))
# ggplot(modelMoral_df, aes(x=category, y=emmean)) +
#   ylim(0.98,4) +
#   labs(x = 'Foundation', y='Estimated marginal mean', fill='Foundation') +
#   geom_violin(data=data_old, mapping=aes(y=moral_decision, fill=category), alpha=0.85, bw=0.45) + 
#   geom_pointrange(aes(ymin=lower.CL, ymax=upper.CL), alpha=1, fatten=5, color='black') +
#   MFT_fill() + MFT_color() +
#   theme_pubr(legend = 'none',
#              base_family = 'Times New Roman',
#              base_size = 20) +
#   theme(axis.title.x = element_blank())
# ggsave('figures/paper/plot_modelMoral.png', dpi=300)
```